---
layout: aesthetihawk
active_tab: chatroom
title: Chat Room
type: issues
permalink: /student/chatroom
comments: false
---

<div class="min-h-screen bg-neutral-900 py-10">
  <div class="max-w-4xl mx-auto px-4">
    <!-- Loading Indicator -->
    <div id="loadingOverlay" class="hidden fixed bottom-4 right-4 z-40 bg-neutral-800/90 backdrop-blur-sm border border-neutral-700 rounded-full px-3 py-1.5 flex items-center gap-2 shadow-md text-xs">
      <div class="loading-spinner"></div>
      <span id="loadingText" class="text-gray-400">Loading...</span>
    </div>

    <!-- Page Title -->
    <h2 class="text-2xl font-semibold text-white mb-6">Chat Room</h2>

    <!-- Chat Container -->
    <div class="bg-neutral-800 border border-neutral-700 rounded-lg shadow-md flex flex-col" style="height: 70vh;">
      <!-- Messages Area -->
      <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-3">
        <!-- Messages will be injected here -->
        <div id="emptyState" class="flex items-center justify-center h-full text-gray-500">
          <div class="text-center">
            <svg class="mx-auto h-12 w-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            <p>No messages yet. Start the conversation!</p>
          </div>
        </div>
      </div>

      <!-- Message Input -->
      <div class="px-4 py-4 border-t border-neutral-700">
        <div class="flex gap-3">
          <input type="text" id="messageInput" placeholder="Type your message..."
            class="flex-1 px-4 py-3 bg-neutral-700 text-white placeholder-gray-400 border border-neutral-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
            onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }" />
          <button onclick="sendMessage()"
            class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition-colors font-medium flex items-center gap-2">
            <span>Send</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .loading-spinner {
    width: 12px;
    height: 12px;
    border: 1.5px solid #6b7280;
    border-top-color: #818cf8;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .message-bubble {
    max-width: 75%;
    word-wrap: break-word;
  }

  .message-own {
    background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
  }

  .message-other {
    background: #404040;
  }

  #messagesContainer::-webkit-scrollbar {
    width: 6px;
  }

  #messagesContainer::-webkit-scrollbar-track {
    background: #262626;
  }

  #messagesContainer::-webkit-scrollbar-thumb {
    background: #525252;
    border-radius: 3px;
  }
</style>

<script type="module">
import { javaURI, pythonURI, fetchOptions } from '{{site.baseurl}}/assets/js/api/config.js';

/* ================================
   STATE
================================ */
let messages = [];
let currentUser = null;
let pollingInterval = null;
let lastMessageId = 0;

/* ================================
   LOADING HELPERS
================================ */
function showLoading(message = "Loading...") {
  document.getElementById("loadingText").textContent = message;
  document.getElementById("loadingOverlay").classList.remove("hidden");
}

function hideLoading() {
  document.getElementById("loadingOverlay").classList.add("hidden");
}

/* ================================
   INIT
================================ */
document.addEventListener("DOMContentLoaded", () => {
  initializeChat();
});

async function initializeChat() {
  showLoading("Connecting...");

  try {
    // Get current user
    const userRes = await fetch(`${pythonURI}/api/id`, fetchOptions);
    if (userRes.ok) {
      currentUser = await userRes.json();
    }

    // Load existing messages
    await loadMessages();

    // Start polling for new messages
    startPolling();
  } catch (err) {
    console.error("Failed to initialize chat:", err);
  } finally {
    hideLoading();
  }
}

/* ================================
   API CALLS
================================ */
async function loadMessages() {
  try {
    const res = await fetch(`${javaURI}/api/chat/messages`, fetchOptions);
    if (res.ok) {
      messages = await res.json();
      if (messages.length > 0) {
        lastMessageId = Math.max(...messages.map(m => m.id));
      }
      renderMessages();
    }
  } catch (err) {
    console.error("Failed to load messages:", err);
  }
}

async function fetchNewMessages() {
  try {
    const res = await fetch(`${javaURI}/api/chat/messages?after=${lastMessageId}`, fetchOptions);
    if (res.ok) {
      const newMessages = await res.json();
      if (newMessages.length > 0) {
        messages = [...messages, ...newMessages];
        lastMessageId = Math.max(...newMessages.map(m => m.id));
        renderMessages();
        scrollToBottom();
      }
    }
  } catch (err) {
    console.error("Failed to fetch new messages:", err);
  }
}

function startPolling() {
  // Poll for new messages every 3 seconds
  pollingInterval = setInterval(fetchNewMessages, 3000);
}

function stopPolling() {
  if (pollingInterval) {
    clearInterval(pollingInterval);
    pollingInterval = null;
  }
}

window.sendMessage = async function() {
  const input = document.getElementById("messageInput");
  const content = input.value.trim();

  if (!content) return;

  if (!currentUser) {
    alert("Please log in to send messages");
    return;
  }

  // Clear input immediately for better UX
  input.value = "";

  // Optimistically add message to UI
  const tempMessage = {
    id: Date.now(),
    content: content,
    sender: currentUser,
    timestamp: new Date().toISOString(),
    pending: true
  };
  messages.push(tempMessage);
  renderMessages();
  scrollToBottom();

  try {
    const res = await fetch(`${javaURI}/api/chat/messages`, {
      ...fetchOptions,
      method: "POST",
      body: JSON.stringify({ content: content })
    });

    if (res.ok) {
      const savedMessage = await res.json();
      // Replace temp message with saved one
      const idx = messages.findIndex(m => m.id === tempMessage.id);
      if (idx !== -1) {
        messages[idx] = savedMessage;
        lastMessageId = Math.max(lastMessageId, savedMessage.id);
      }
      renderMessages();
    } else {
      // Remove failed message
      messages = messages.filter(m => m.id !== tempMessage.id);
      renderMessages();
      alert("Failed to send message");
    }
  } catch (err) {
    console.error("Failed to send message:", err);
    messages = messages.filter(m => m.id !== tempMessage.id);
    renderMessages();
    alert("Failed to send message");
  }
}

/* ================================
   RENDERING
================================ */
function renderMessages() {
  const container = document.getElementById("messagesContainer");
  const emptyState = document.getElementById("emptyState");

  if (!messages || messages.length === 0) {
    container.innerHTML = '';
    container.appendChild(emptyState);
    emptyState.classList.remove("hidden");
    return;
  }

  emptyState.classList.add("hidden");

  container.innerHTML = messages.map(msg => {
    const isOwn = currentUser && msg.sender && msg.sender.uid === currentUser.uid;
    const senderName = msg.sender?.name || msg.sender?.uid || "Unknown";
    const time = formatTime(msg.timestamp);
    const pendingClass = msg.pending ? "opacity-60" : "";

    return `
      <div class="flex ${isOwn ? 'justify-end' : 'justify-start'} ${pendingClass}">
        <div class="message-bubble ${isOwn ? 'message-own' : 'message-other'} rounded-lg px-4 py-2">
          ${!isOwn ? `<div class="text-xs text-indigo-400 font-medium mb-1">${senderName}</div>` : ''}
          <div class="text-white text-sm">${escapeHtml(msg.content)}</div>
          <div class="text-xs ${isOwn ? 'text-indigo-200' : 'text-gray-400'} mt-1 text-right">
            ${time}${msg.pending ? ' - sending...' : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');

  scrollToBottom();
}

function formatTime(timestamp) {
  if (!timestamp) return '';
  const date = new Date(timestamp);
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function scrollToBottom() {
  const container = document.getElementById("messagesContainer");
  container.scrollTop = container.scrollHeight;
}

// Cleanup on page unload
window.addEventListener("beforeunload", () => {
  stopPolling();
});
</script>
