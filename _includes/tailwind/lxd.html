<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/darcula.min.css">

<div class="container mx-auto px-4 py-8 bg-black/5 backdrop-blur-sm rounded-xl relative">
  <!-- Pearly glow effect around container -->
  <div class="absolute -inset-1 bg-gradient-to-r from-indigo-200 via-purple-200 to-pink-200 rounded-xl opacity-40 blur-xl"></div>
  <div class="relative z-10">
    <!-- Title and Description -->
    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">{{ page.lxdData.Title }}</h1>
      <p class="text-xl text-gray-300 max-w-4xl mx-auto">{{ page.lxdData.Description }}</p>
    </div>

    <!-- Prerequisites Section -->
    {% if page.lxdData.Prequisites %}
    <div class="mb-8">
      <h2 class="text-2xl font-semibold text-white mb-2">Prerequisites</h2>
      <ul class="flex flex-wrap gap-4 justify-center">
        {% for prereq in page.lxdData.Prequisites %}
          <li>
            <a href="{{ prereq.link }}" class="bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-500 transition">
              {{ prereq.title }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <!-- Selection Panel -->
    <div class="mb-8 bg-gray-800/50 rounded-xl p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-white">My Onboarding Hacks</h2>
        <div class="flex gap-3">
          <button id="select-hacks-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg transition font-semibold">
            Select Hacks
          </button>
          <p id="hacks-status" class="text-sm text-gray-300 self-center">Loading...</p>
        </div>
      </div>

      <!-- Selected Hacks Display -->
      <div id="selected-hacks-container">
        <p class="text-gray-400 text-center py-8">No hacks selected. Click "Select Hacks" to choose your onboarding tasks.</p>
      </div>
    </div>

    <!-- Modal for Hack Selection -->
    <div id="hacks-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999; background-color: rgba(0,0,0,0.8); overflow-y: auto;">
      <div style="position: relative; background-color: #1a1a1a; padding: 24px; border-radius: 12px; max-width: 56rem; width: 90%; max-height: 85vh; overflow-y: auto; border: 1px solid #374151; z-index: 100000; margin: 40px auto;">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-2xl font-bold text-white" style="color: white;">Choose Your Onboarding Hacks</h3>
          <button id="modal-close-btn" class="text-gray-400 hover:text-white text-3xl font-bold leading-none" style="color: #9ca3af; font-size: 2rem; line-height: 1; cursor: pointer; background: none; border: none;">&times;</button>
        </div>
        <p class="text-gray-300 mb-6" style="color: #d1d5db; margin-bottom: 1.5rem;">Select the hacks you want to work on. They'll appear at the top of the page for easy access.</p>
        
        <div id="hacks-checklist" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; max-height: 400px; overflow-y: auto; padding: 8px; margin-bottom: 1.5rem;">
          <!-- Checkboxes will be populated here -->
        </div>
        
        <div style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 16px; border-top: 1px solid #374151;">
          <button id="modal-cancel-btn" style="padding: 8px 20px; border-radius: 8px; background-color: #374151; color: white; cursor: pointer; border: none; font-weight: 500;">
            Cancel
          </button>
          <button id="modal-save-btn" style="padding: 8px 20px; border-radius: 8px; background-color: #16a34a; color: white; cursor: pointer; border: none; font-weight: 600;">
            Save Selection
          </button>
        </div>
      </div>
    </div>

    <!-- All Topics Cards Grid (Full List) -->
    <div class="mb-8">
      <h2 class="text-2xl font-semibold text-white mb-6">All Available Hacks</h2>
      <div class="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-2 xl:grid-cols-2 gap-6">
        {% for topic in page.lxdData.Topics %}
          <div class="bg-gray-800 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden group transform hover:-translate-y-2" data-game="{{ topic.Game }}">
            <div class="relative h-40 overflow-hidden bg-gradient-to-br from-gray-700 to-gray-900 mb-4">
              <a href="{{ topic.Game }}" class="block w-full h-full group">
                <img src="{{ topic.Image }}" alt="{{ topic.Alt }}" class="w-full h-full object-cover transition-all duration-300 group-hover:scale-110">
                <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                  <div class="bg-white bg-opacity-90 rounded-full p-3">
                    <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path d="M8 5v10l8-5z"/></svg>
                  </div>
                </div>
              </a>
            </div>
            <div class="p-6">
              <div class="flex items-start justify-between mb-2">
                <h3 class="text-xl font-bold text-white">{{ topic.Title }}</h3>
                <span class="inline-block px-2 py-1 text-xs rounded-full bg-gray-700 text-gray-300" data-status-badge>Not selected</span>
              </div>
              <p class="text-sm text-gray-400 mb-2">{{ topic.Genre }} | Level: {{ topic.Level }}</p>
              <p class="text-gray-300 text-sm mb-4">{{ topic.Description }}</p>
              <div class="mb-4">
                <span class="text-sm font-semibold text-gray-200">Categories:</span>
                <div class="flex flex-wrap gap-1 mt-1">
                  {% for cat in topic.Categories %}
                    <span class="bg-blue-900 text-blue-200 text-xs px-2 py-1 rounded-full">{{ cat }}</span>
                  {% endfor %}
                </div>
              </div>
              <div class="flex gap-2">
                <a href="{{ topic.Game }}" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-center py-2 rounded-lg font-semibold transition">Play Game</a>
                <a href="{{ topic.Lessons }}" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white text-center py-2 rounded-lg font-semibold transition">Lessons</a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Submission Modal -->
<div id="submission-modal" style="display:none; position: fixed; top:0; left:0; right:0; bottom:0; z-index:99999; background-color: rgba(0,0,0,0.8); overflow-y:auto;">
  <div style="position: relative; background-color: #1a1a1a; padding:24px; border-radius:12px; max-width:700px; width:90%; margin:40px auto; border:1px solid #374151;">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-2xl font-bold text-white">Submit Your Work</h3>
      <button onclick="closeSubmissionModal()" style="font-size:2rem; background:none; border:none; color:#9ca3af; cursor:pointer;">&times;</button>
    </div>

    <!-- Dynamic Rubric Checklist -->
    <div id="submission-checklist" class="mb-4">
      <div class="flex items-center justify-between mb-3">
        <h4 class="text-lg font-semibold text-white">Grading Rubric</h4>
        <button id="view-full-rubric-btn" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded text-sm font-semibold transition">
          View Full Rubric
        </button>
      </div>
      
      <div id="rubric-items-container" class="space-y-3 mb-4">
        <!-- Rubric items will be dynamically loaded here -->
      </div>
    </div>

    <textarea id="submission-text" rows="8" style="width:100%; padding:12px; border-radius:8px; border:1px solid #374151; background:#111; color:white;" placeholder="Write your submission here..."></textarea>

    <div style="display:flex; justify-content:flex-end; margin-top:16px;">
      <button id="submission-btn" onclick="submitHack()" disabled style="padding:8px 20px; border-radius:8px; background-color:#16a34a; color:white; border:none; font-weight:600; opacity:0.5; cursor:not-allowed;">
        Submit
      </button>
    </div>
  </div>
</div>

<!-- Full Rubric Modal -->
<div id="full-rubric-modal" style="display:none; position: fixed; top:0; left:0; right:0; bottom:0; z-index:100000; background-color: rgba(0,0,0,0.85); overflow-y:auto;">
  <div style="position: relative; background-color: #1a1a1a; padding:24px; border-radius:12px; max-width:800px; width:90%; margin:40px auto; border:1px solid #374151; max-height: 85vh; overflow-y: auto;">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-2xl font-bold text-white">Complete Grading Rubric</h3>
      <button onclick="closeFullRubricModal()" style="font-size:2rem; background:none; border:none; color:#9ca3af; cursor:pointer;">&times;</button>
    </div>

    <div id="full-rubric-content" class="space-y-4">
      <!-- Full rubric will be dynamically loaded here -->
    </div>

    <div style="display:flex; justify-content:flex-end; margin-top:24px; padding-top:16px; border-top:1px solid #374151;">
      <button onclick="closeFullRubricModal()" style="padding:8px 20px; border-radius:8px; background-color:#374151; color:white; border:none; font-weight:500; cursor:pointer;">
        Close
      </button>
    </div>
  </div>
</div>

<script>
  // Topics data from Jekyll
  const HACK_TOPICS = {{ page.lxdData.Topics | jsonify }};
  
  // Default rubric structure - this should match what graders use
  const DEFAULT_RUBRIC = {
    total: 0.90,
    categories: [
      {
        name: "Individual Contribution",
        weight: 0.45,
        subcategories: [
          { name: "Commits in GitHub", weight: 0.15 },
          { name: "Collaboration", weight: 0.15 },
          { name: "Soft skills integration", weight: 0.15 }
        ]
      },
      {
        name: "Technicals",
        weight: 0.30,
        subcategories: [
          { name: "Code quality & organization", weight: 0.10 },
          { name: "Implementation of features", weight: 0.10 },
          { name: "Problem-solving approach", weight: 0.10 }
        ]
      },
      {
        name: "Presentation",
        weight: 0.15,
        subcategories: [
          { name: "Clear documentation", weight: 0.05 },
          { name: "Live demo/explanation", weight: 0.05 },
          { name: "Response to questions", weight: 0.05 }
        ]
      }
    ]
  };
  
  // User's grade data
  let userGradeData = {
    selected_hacks: [],
    hacks_completed: {},
    hacks_submissions: {},
    rubric: DEFAULT_RUBRIC // Store the rubric that applies to this student
  };
  
  let isAuthenticated = false;
  let currentHackToSubmit = null;

  // API base URL - adjust if needed
  const API_BASE = '';

  // Load user's grade data from backend (with localStorage fallback)
  async function loadGradeData() {
    try {
      const response = await fetch(`${API_BASE}/api/grade_data`, {
        method: 'GET',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const data = await response.json();
        isAuthenticated = true;
        userGradeData = data.grade_data || { selected_hacks: [], hacks_completed: {}, hacks_submissions: {}, rubric: DEFAULT_RUBRIC };
        if (!userGradeData.selected_hacks) userGradeData.selected_hacks = [];
        if (!userGradeData.hacks_completed) userGradeData.hacks_completed = {};
        if (!userGradeData.hacks_submissions) userGradeData.hacks_submissions = {};
        if (!userGradeData.rubric) userGradeData.rubric = DEFAULT_RUBRIC;
        console.log('Loaded from backend:', userGradeData);
        return true;
      } else {
        throw new Error('Backend not available');
      }
    } catch (error) {
      console.log('Backend not available, using localStorage fallback');
      isAuthenticated = false;
      
      const stored = localStorage.getItem('onboarding_hacks_data');
      if (stored) {
        try {
          userGradeData = JSON.parse(stored);
          if (!userGradeData.selected_hacks) userGradeData.selected_hacks = [];
          if (!userGradeData.hacks_completed) userGradeData.hacks_completed = {};
          if (!userGradeData.hacks_submissions) userGradeData.hacks_submissions = {};
          if (!userGradeData.rubric) userGradeData.rubric = DEFAULT_RUBRIC;
          console.log('Loaded from localStorage:', userGradeData);
        } catch (e) {
          console.error('Error parsing localStorage data:', e);
          userGradeData = { selected_hacks: [], hacks_completed: {}, hacks_submissions: {}, rubric: DEFAULT_RUBRIC };
        }
      } else {
        userGradeData = { selected_hacks: [], hacks_completed: {}, hacks_submissions: {}, rubric: DEFAULT_RUBRIC };
      }
      return false;
    }
  }

  // Save user's grade data to backend (with localStorage fallback)
  async function saveGradeData() {
    if (isAuthenticated) {
      try {
        const response = await fetch(`${API_BASE}/api/grade_data`, {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ grade_data: userGradeData })
        });

        if (response.ok) {
          console.log('Saved to backend');
          return true;
        } else {
          throw new Error('Backend save failed');
        }
      } catch (error) {
        console.log('Backend save failed, falling back to localStorage');
        isAuthenticated = false;
      }
    }
    
    try {
      localStorage.setItem('onboarding_hacks_data', JSON.stringify(userGradeData));
      console.log('Saved to localStorage:', userGradeData);
      return true;
    } catch (error) {
      console.error('Error saving to localStorage:', error);
      return false;
    }
  }

  // Render dynamic rubric in submission modal
  function renderSubmissionRubric() {
    const container = document.getElementById('rubric-items-container');
    const rubric = userGradeData.rubric || DEFAULT_RUBRIC;
    
    container.innerHTML = rubric.categories.map(category => `
      <div class="bg-gray-800 p-3 rounded-lg">
        <label class="flex items-start gap-3 cursor-pointer">
          <input type="checkbox" class="submission-checkbox mt-1 h-4 w-4 rounded border-gray-600 text-blue-600">
          <div class="flex-1">
            <div class="text-white font-medium">${category.name} (${category.weight.toFixed(2)})</div>
            <ul class="text-sm text-gray-300 mt-1 space-y-1 ml-2">
              ${category.subcategories.map(sub => `
                <li>• ${sub.name} (${sub.weight.toFixed(2)})</li>
              `).join('')}
            </ul>
          </div>
        </label>
      </div>
    `).join('');
  }

  // Render full rubric modal
  function renderFullRubric() {
    const container = document.getElementById('full-rubric-content');
    const rubric = userGradeData.rubric || DEFAULT_RUBRIC;
    
    container.innerHTML = `
      <div class="bg-gray-800 p-4 rounded-lg mb-4">
        <h4 class="text-xl font-bold text-white mb-2">Total Points: ${rubric.total.toFixed(2)}</h4>
        <p class="text-gray-300 text-sm">This rubric shows how your work will be evaluated. Make sure to address all categories for full credit.</p>
      </div>
      
      ${rubric.categories.map((category, idx) => `
        <div class="bg-gray-800 p-4 rounded-lg">
          <h4 class="text-lg font-bold text-white mb-3">${idx + 1}. ${category.name} (${category.weight.toFixed(2)} points)</h4>
          <div class="space-y-2 ml-4">
            ${category.subcategories.map((sub, subIdx) => `
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <span class="text-white font-medium">${String.fromCharCode(97 + subIdx)}. ${sub.name}</span>
                </div>
                <span class="text-blue-400 font-semibold ml-4">${sub.weight.toFixed(2)} pts</span>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('')}
    `;
  }

  // Open full rubric modal
  window.openFullRubricModal = function() {
    renderFullRubric();
    const modal = document.getElementById('full-rubric-modal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  };

  // Close full rubric modal
  window.closeFullRubricModal = function() {
    const modal = document.getElementById('full-rubric-modal');
    modal.style.display = 'none';
    document.body.style.overflow = '';
  };

  // Render the checklist in the modal
  function renderChecklist() {
    const container = document.getElementById('hacks-checklist');
    container.innerHTML = '';

    HACK_TOPICS.forEach((topic, index) => {
      const isChecked = (userGradeData.selected_hacks || []).includes(topic.Game);
      
      const label = document.createElement('label');
      label.className = 'flex items-start gap-3 p-3 rounded-lg bg-gray-800 hover:bg-gray-750 cursor-pointer transition border border-gray-700 hover:border-blue-500';
      
      label.innerHTML = `
        <input type="checkbox" 
               data-game="${topic.Game}" 
               ${isChecked ? 'checked' : ''} 
               class="mt-1 h-4 w-4 rounded border-gray-600 text-blue-600 focus:ring-blue-500">
        <div class="flex-1">
          <div class="font-semibold text-white">${topic.Title}</div>
          <div class="text-xs text-gray-400">Level ${topic.Level} • ${topic.Genre}</div>
        </div>
      `;
      
      container.appendChild(label);
    });
  }

  // Render selected hacks at the top
  function renderSelectedHacks() {
    const container = document.getElementById('selected-hacks-container');
    const selectedGames = userGradeData.selected_hacks || [];

    if (selectedGames.length === 0) {
      container.innerHTML = '<p class="text-gray-400 text-center py-8">No hacks selected. Click "Select Hacks" to choose your onboarding tasks.</p>';
      return;
    }

    container.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        ${selectedGames.map(gamePath => {
          const topic = HACK_TOPICS.find(t => t.Game === gamePath);
          if (!topic) return '';
          
          const isCompleted = userGradeData.hacks_completed && userGradeData.hacks_completed[gamePath];
          
          return `
            <div class="bg-gray-800 rounded-xl p-4 border-2 ${isCompleted ? 'border-green-500' : 'border-blue-500'}">
              <div class="flex items-start justify-between mb-2">
                <h3 class="text-lg font-bold text-white">${topic.Title}</h3>
                <span class="inline-block px-2 py-1 text-xs rounded-full ${isCompleted ? 'bg-green-600 text-white' : 'bg-blue-600 text-white'}">
                  ${isCompleted ? '✓ Complete' : 'In Progress'}
                </span>
              </div>
              <p class="text-sm text-gray-400 mb-1">Level ${topic.Level}</p>
              <p class="text-sm text-gray-300 mb-3">${topic.Description}</p>
              <div class="flex gap-2">
                <a href="${topic.Game}" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-center py-2 px-3 rounded-lg text-sm font-semibold transition">
                  Play
                </a>
                <a href="${topic.Lessons}" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white text-center py-2 px-3 rounded-lg text-sm font-semibold transition">
                  Learn
                </a>
                <button onclick="openSubmissionModal('${gamePath}')" class="px-3 py-2 rounded-lg bg-green-600 hover:bg-green-500 text-white text-sm transition font-semibold">
                  Submit 
                </button>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }

  // Update status badges on all cards
  function updateAllCardBadges() {
    document.querySelectorAll('[data-game]').forEach(card => {
      const gamePath = card.getAttribute('data-game');
      const badge = card.querySelector('[data-status-badge]');
      
      if (badge) {
        const isSelected = (userGradeData.selected_hacks || []).includes(gamePath);
        const isCompleted = userGradeData.hacks_completed && userGradeData.hacks_completed[gamePath];
        
        if (isCompleted) {
          badge.textContent = '✓ Completed';
          badge.className = 'inline-block px-2 py-1 text-xs rounded-full bg-green-600 text-white';
        } else if (isSelected) {
          badge.textContent = 'Selected';
          badge.className = 'inline-block px-2 py-1 text-xs rounded-full bg-blue-600 text-white';
        } else {
          badge.textContent = 'Not selected';
          badge.className = 'inline-block px-2 py-1 text-xs rounded-full bg-gray-700 text-gray-300';
        }
      }
    });
  }

  // Update status message
  function updateStatus(message, isError = false) {
    const statusEl = document.getElementById('hacks-status');
    statusEl.textContent = message;
    statusEl.className = `text-sm self-center ${isError ? 'text-red-400' : 'text-gray-300'}`;
  }

  // Update the status display with counts
  function updateStatusDisplay() {
    const selectedCount = (userGradeData.selected_hacks || []).length;
    const completedCount = Object.values(userGradeData.hacks_completed || {}).filter(Boolean).length;
    updateStatus(`${selectedCount} selected • ${completedCount} completed`);
  }

  // Modal functions
  function openModal() {
    const modal = document.getElementById('hacks-modal');
    if (!modal) return;
    renderChecklist();
    modal.style.display = 'flex';
    modal.style.visibility = 'visible';
    modal.style.opacity = '1';
    window.scrollTo({ top: 0, behavior: 'smooth' });
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    const modal = document.getElementById('hacks-modal');
    if (modal) {
      modal.style.display = 'none';
      modal.style.visibility = 'hidden';
      modal.style.opacity = '0';
      document.body.style.overflow = '';
    }
  }

  async function saveSelection() {
    const checkboxes = document.querySelectorAll('#hacks-checklist input[type="checkbox"]');
    userGradeData.selected_hacks = Array.from(checkboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.getAttribute('data-game'));

    const saved = await saveGradeData();
    
    if (saved) {
      closeModal();
      renderSelectedHacks();
      updateAllCardBadges();
      updateStatus('Selection saved!');
      setTimeout(() => updateStatusDisplay(), 1500);
    } else {
      updateStatus('Failed to save selection', true);
    }
  }
  
  // Update submit button state based on checkboxes
  function updateSubmitButtonState() {
    const checkboxes = document.querySelectorAll('#submission-checklist .submission-checkbox');
    const btn = document.getElementById('submission-btn');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    
    btn.disabled = !allChecked;
    btn.style.opacity = allChecked ? '1' : '0.5';
    btn.style.cursor = allChecked ? 'pointer' : 'not-allowed';
  }

  // Open submission modal
  window.openSubmissionModal = function(gamePath) {
    currentHackToSubmit = gamePath;
    document.getElementById('submission-text').value = userGradeData.hacks_submissions?.[gamePath] || '';
    
    const modal = document.getElementById('submission-modal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // Render the rubric based on current user data
    renderSubmissionRubric();

    // Reset checkboxes
    const checkboxes = document.querySelectorAll('#submission-checklist .submission-checkbox');
    checkboxes.forEach(cb => cb.checked = false);

    updateSubmitButtonState();

    // Add event listeners to checkboxes
    checkboxes.forEach(cb => {
      cb.addEventListener('change', updateSubmitButtonState);
    });
  };
  
  // Close submission modal
  window.closeSubmissionModal = function() {
    const modal = document.getElementById('submission-modal');
    modal.style.display = 'none';
    document.body.style.overflow = '';
  };
  
  // Submit hack
  window.submitHack = async function() {
    const text = document.getElementById('submission-text').value.trim();
    if (!text) {
      alert('Please write something before submitting.');
      return;
    }
    
    if (!userGradeData.hacks_submissions) userGradeData.hacks_submissions = {};
    userGradeData.hacks_submissions[currentHackToSubmit] = text;
    
    // Mark as completed
    userGradeData.hacks_completed[currentHackToSubmit] = true;
    await saveGradeData();
    
    renderSelectedHacks();
    updateAllCardBadges();
    closeSubmissionModal();
    updateStatus('Submission saved!');
    setTimeout(updateStatusDisplay, 1500);
  };

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', async () => {
    await loadGradeData();
    renderSelectedHacks();
    updateAllCardBadges();
    updateStatusDisplay();

    // Event listeners
    const selectBtn = document.getElementById('select-hacks-btn');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const modalSaveBtn = document.getElementById('modal-save-btn');
    const viewRubricBtn = document.getElementById('view-full-rubric-btn');

    if (selectBtn) {
      selectBtn.addEventListener('click', (e) => {
        e.preventDefault();
        openModal();
      });
    }

    if (modalCloseBtn) {
      modalCloseBtn.addEventListener('click', (e) => {
        e.preventDefault();
        closeModal();
      });
    }

    if (modalCancelBtn) {
      modalCancelBtn.addEventListener('click', (e) => {
        e.preventDefault();
        closeModal();
      });
    }

    if (modalSaveBtn) {
      modalSaveBtn.addEventListener('click', (e) => {
        e.preventDefault();
        saveSelection();
      });
    }

    if (viewRubricBtn) {
      viewRubricBtn.addEventListener('click', (e) => {
        e.preventDefault();
        openFullRubricModal();
      });
    }
  });