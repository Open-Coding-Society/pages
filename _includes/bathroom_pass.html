<style>
    .pass-container {
        width: 300px;
        background-color: #771414;
        padding: 20px;
        margin: 20px auto;
        text-align: center;
        border-radius: 10px;
        font-family: Arial, sans-serif;
        color: rgb(255, 255, 255);
    }

    .signature-canvas {
        border: 2px solid #000;
        margin-bottom: 10px;
    }

    .save-button {
        background-color: #4caf50;
        color: white;
        padding: 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .hidden {
        display: none;
    }

    .dropdown {
        width: 200px;
        margin: 20px;
    }

    .result {
        margin-top: 20px;
    }
</style>
<title>Pass</title>


<div class="pass-container" id="form-pass">
    <h2>A101 Pass</h2>
    <label for="studentName">Name: </label>
    <div style="display: flex; gap: 10px; align-items: center; justify-content: center; margin-bottom: 20px;">
        <input type="text" id="studentName" placeholder="Enter name here" style="flex-grow: 1;">
        <button class="medium primary" id="scanFaceBtn" type="button" onclick="toggleWebcam()">Scan Face</button>
    </div>

    <!-- Webcam Container (Hidden by default) -->
    <div id="webcamContainer" class="hidden" style="margin-bottom: 20px;">
        <div style="position: relative; width: 100%; max-width: 320px; margin: 0 auto;">
            <video id="webcam" style="width: 100%; border-radius: 8px;" autoplay playsinline></video>
            <canvas id="canvas" class="hidden"></canvas>
            <div id="scanStatus" style="color: white; margin-top: 5px;"></div>
        </div>
        <button class="medium" style="background-color: #666; margin-top: 10px;" onclick="stopWebcam()">Cancel
            Scan</button>
    </div>

    <label for="choices">Choose Location:</label>
    <select id="choices" class="dropdown">
        <option value="Bathroom">Bathroom</option>
        <option value="Health Office">Health Office</option>
        <option value="Library">Library</option>
    </select>
    <br>

    <label for="signature">Teacher's Signature:</label><br>
    <canvas id="signatureCanvas" width="250" height="200"></canvas>
    <button class="medium primary" onclick="clearSignature()">Clear</button><br><br>
    <button class="medium primary" onclick="submitForm()">Submit</button>
    <br>
    <br>
    <button class="medium primary" onclick="randomize()">Randomize Color</button>
</div>

<div class="pass-container hidden" id="completed-pass">
    <h2>A101 Pass</h2>
    <p>Name: <span id="nameDisplay"></span></p>
    <p>Date & time: <span id="dateTimeDisplay"></span></p>
    <p>Teacher's Signature:<span id="signature"></span></p>
    <img id="signatureDisplay" src="" alt="Signature" class="signature-canvas">
    <!-- <p>Teacher's approval: <span id="approvalDisplay">[âœ“]</span></p> -->
    <img src="https://github.com/user-attachments/assets/c350ab11-f560-4c76-b1f3-8bfbce017f77" alt="Teacher"
        style="width: 100px; height: auto;">
    <p>Good job not using any paper! You're saving both the environment and your seed &#128585;!</p>
    <strong id="goingto"></strong>
</div>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
    const canvas = document.querySelector('#signatureCanvas');
    const signaturePad = new SignaturePad(canvas);
    const saveButton = document.querySelector('#saveButton');
    var selectedLocation = 0;
    const going_to = document.getElementById('choices');
    //Check location change
    console.log(going_to.value);

    //saveButton.addEventListener('click', function () {});
    function clearSignature() {
        signaturePad.clear();
    }

    function submitForm() {
        var name = document.getElementById('studentName').value;

        if (name && !signaturePad.isEmpty()) {
            var currentDateTime = new Date().toLocaleString();

            document.getElementById('nameDisplay').innerText = name;
            document.getElementById('dateTimeDisplay').innerText = currentDateTime;
            document.getElementById('goingto').innerText = `Going to ${going_to.value}`;

            // Get the data URL of the signature and set it in the completed pass
            var dataURL = signaturePad.toDataURL();
            document.getElementById('signatureDisplay').src = dataURL;

            document.getElementById('form-pass').classList.add('hidden');
            document.getElementById('completed-pass').classList.remove('hidden');
        }
        else {
            alert('Please enter your name and sign the form.');
        }
    }
    function getRandomColor() {
        var red = Math.floor(Math.random() * 256);
        var green = Math.floor(Math.random() * 256);
        var blue = Math.floor(Math.random() * 256);
        return "rgb(" + red + "," + green + "," + blue + ")";
    }
    function randomize() {

        var elements = document.getElementsByClassName("pass-container");
        bgColor = getRandomColor()
        fontColor = getRandomColor()
        for (var i = 0; i < elements.length; i++) {
            elements[i].style.backgroundColor = bgColor;
        }
    };

    //document.getElementById("completed-pass").style.backgroundColor = getRandomColor();
    //document.getElementById("completed-pass").style.color = getRandomColor();


    // Facial Recognition Logic
    let stream = null;
    let scanInterval = null;
    const video = document.getElementById('webcam');
    const canvasElement = document.getElementById('canvas');
    const webcamContainer = document.getElementById('webcamContainer');
    const statusDiv = document.getElementById('scanStatus');
    const nameInput = document.getElementById('studentName');

    // Import config - we need pythonURI. Since this is a script tag inside an include, 
    // we might not have module support directly unless type="module".
    // Alternatively, we can assume pythonURI is available globally if defined elsewhere or hardcode/detect it.
    // For now, let's try to detect it or use a fallback.
    const pythonURI = location.hostname === "localhost" || location.hostname === "127.0.0.1"
        ? "http://localhost:8587"
        : "https://flask.opencodingsociety.com";

    async function toggleWebcam() {
        if (!webcamContainer.classList.contains('hidden')) {
            stopWebcam();
        } else {
            webcamContainer.classList.remove('hidden');
            statusDiv.innerText = "Accessing camera...";
            startWebcam();
        }
    }

    async function startWebcam() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            statusDiv.innerText = "Scanning...";

            // Start scanning loop
            scanInterval = setInterval(scanFace, 3000); // Scan every 3 seconds
        } catch (err) {
            console.error("Error accessing webcam:", err);
            statusDiv.innerText = "Error: Could not access camera.";
        }
    }

    function stopWebcam() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        if (scanInterval) {
            clearInterval(scanInterval);
            scanInterval = null;
        }
        webcamContainer.classList.add('hidden');
        statusDiv.innerText = "";
    }

    async function scanFace() {
        if (!stream) return;

        // Draw video frame to canvas
        canvasElement.width = video.videoWidth;
        canvasElement.height = video.videoHeight;
        const ctx = canvasElement.getContext('2d');
        ctx.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);

        // Get base64 data
        const dataUrl = canvasElement.toDataURL('image/jpeg');
        const base64Data = dataUrl.split(',')[1];

        statusDiv.innerText = "Identifying...";

        try {
            const response = await fetch(`${pythonURI}/api/identify`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Add credentials if needed
                },
                body: JSON.stringify({ image: base64Data })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.match) {
                    statusDiv.innerText = `Identified: ${data.name}`;
                    nameInput.value = data.name;

                    // Visual feedback
                    nameInput.style.backgroundColor = "#e8f0fe";
                    setTimeout(() => nameInput.style.backgroundColor = "", 1000);

                    // Stop scanning after success
                    setTimeout(stopWebcam, 1500);
                } else {
                    statusDiv.innerText = "No match found. Scanning...";
                }
            } else {
                statusDiv.innerText = "Server error during scan.";
            }
        } catch (error) {
            console.error("Scan error:", error);
            statusDiv.innerText = "Connection error.";
        }
    }

    // Override existing logic if needed or ensure it coexists
    /* randomize(); */ // Call existng function if we want to run it on load logic

</script>