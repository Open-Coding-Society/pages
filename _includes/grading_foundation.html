<!-- ===================== GRADING FEATURE ===================== -->

<script>
  // Global feature registry (safe)
  window.PageFeatures = window.PageFeatures || {};
  // If a page sets grading=true in front matter, layout will include this file
  window.PageFeatures.grading = true;
</script>

<!-- Button Container -->
<div id="grading-button-container" class="grading-button-container"></div>

<!-- Grading Toggle Button -->
<button
  id="grading-toggle-btn"
  class="grading-btn"
  aria-label="Open Grading"
  hidden
>
  Grading
</button>

<!-- Grading Panel -->
<aside
  id="grading-panel"
  class="grading-panel"
  tabindex="-1"
  aria-label="Grading Panel"
  hidden
>
  <div class="grading-panel-inner">
    <header class="grading-header">
      <h1>Grading Dashboard</h1>
      <button
        id="grading-close-btn"
        class="grading-close-btn"
        aria-label="Close Grading"
      >&times;</button>
    </header>

    <section id="grading-content">
      <em>Loading submissions...</em>
    </section>
  </div>
</aside>

<!-- Rubric Popup (simple) -->
<div
  id="rubric-popup"
  style="position:fixed; inset:0; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:9999;"
>
  <div style="background:#000; padding:1rem; border:1px solid #63b3ed; border-radius:8px; width:300px; color:white;">
    <h3 style="margin-top:0;">Rubric</h3>

    <div id="rubric-categories"></div>

    <textarea
      id="rubric-comments"
      placeholder="Comments..."
      style="width:100%; margin-top:10px; background:#111; color:white; height:60px; border:1px solid #63b3ed; border-radius:4px;"
    ></textarea>

    <button
      id="rubric-save"
      style="width:100%; margin-top:10px; background:#111; color:#63b3ed; border:1px solid #63b3ed; padding:6px; border-radius:4px;"
    >
      Save
    </button>

    <button
      id="rubric-cancel"
      style="width:100%; margin-top:8px; background:#111; color:#fff; border:1px solid #444; padding:6px; border-radius:4px;"
    >
      Cancel
    </button>
  </div>
</div>

<script>
/* ===================== CONTENT ===================== */
const gradingData = [
  { student: "Student A", assignment: "HW1", score: 92, status: "Graded", rubric: { checks: [], comments: "" } },
  { student: "Student B", assignment: "HW1", score: 85, status: "Graded", rubric: { checks: [], comments: "" } },
  { student: "Student C", assignment: "HW1", score: "—", status: "Pending", rubric: { checks: [], comments: "" } },
  { student: "Student A", assignment: "HW2", score: 92, status: "Graded", rubric: { checks: [], comments: "" } },
  { student: "Student B", assignment: "HW2", score: 85, status: "Graded", rubric: { checks: [], comments: "" } },
  { student: "Student C", assignment: "HW2", score: "—", status: "Pending", rubric: { checks: [], comments: "" } },
];

/* ===================== RUBRIC TEMPLATE ===================== */
const rubricTemplate = [
  "Correct format",
  "Answered all questions",
  "Code runs without errors",
  "Comments included"
];

/* ===================== INIT ===================== */
document.addEventListener("DOMContentLoaded", () => {
  if (!window.PageFeatures || !window.PageFeatures.grading) return;

  const container = document.getElementById("grading-button-container");
  const toggleBtn = document.getElementById("grading-toggle-btn");
  const panel = document.getElementById("grading-panel");
  const closeBtn = document.getElementById("grading-close-btn");

  if (!container || !toggleBtn || !panel || !closeBtn) return;

  if (!container.contains(toggleBtn)) container.appendChild(toggleBtn);
  toggleBtn.hidden = false;

  function openGradingPanel() {
    panel.hidden = false;
    renderGradingTable();
  }

  function closeGradingPanel() {
    panel.hidden = true;
  }

  toggleBtn.addEventListener("click", openGradingPanel);
  closeBtn.addEventListener("click", closeGradingPanel);

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !panel.hidden) closeGradingPanel();
    if (e.key === "Escape") closeRubricPopup();
  });
});

/* ===================== TABLE RENDER ===================== */
function renderGradingTable() {
  const container = document.getElementById("grading-content");
  if (!container) return;

  container.innerHTML = `
    <div style="display:flex; gap:.5rem; align-items:center; margin-bottom:1rem;">
      <input
        type="text"
        id="grading-search"
        placeholder="Search by student..."
        style="flex:1; padding: 0.5rem; border-radius: 8px; border: 1px solid #63b3ed; background: #000; color: #fff;"
      />

      <select id="assignment-filter" style="background:#000; color:#fff; border:1px solid #63b3ed; border-radius:8px; padding:0.4rem;">
        <option value="">All assignments</option>
      </select>

      <select id="status-filter" style="background:#000; color:#fff; border:1px solid #63b3ed; border-radius:8px; padding:0.4rem;">
        <option value="">All statuses</option>
      </select>
    </div>

    <table class="grading-table" style="width:100%; border-collapse: collapse; color: #fff;">
      <thead style="background: #111;">
        <tr>
          <th style="border: 1px solid #63b3ed; padding: 0.5rem;">Student</th>
          <th style="border: 1px solid #63b3ed; padding: 0.5rem;">Assignment</th>
          <th style="border: 1px solid #63b3ed; padding: 0.5rem;">Score</th>
          <th style="border: 1px solid #63b3ed; padding: 0.5rem;">Status</th>
          <th style="border: 1px solid #63b3ed; padding: 0.5rem;">Rubric</th>
        </tr>
      </thead>
      <tbody id="grading-tbody"></tbody>
    </table>
  `;

  const tbody = document.getElementById("grading-tbody");

  function updateTable(filter = "") {
    const assignmentSelect = document.getElementById("assignment-filter");
    const statusSelect = document.getElementById("status-filter");
    const assignmentFilter = assignmentSelect ? assignmentSelect.value : "";
    const statusFilter = statusSelect ? statusSelect.value : "";

    const filteredData = gradingData.filter((row) => {
      const matchesStudent = row.student.toLowerCase().includes(filter.toLowerCase());
      const matchesAssignment = !assignmentFilter || row.assignment === assignmentFilter;
      const matchesStatus = !statusFilter || row.status === statusFilter;
      return matchesStudent && matchesAssignment && matchesStatus;
    });

    tbody.innerHTML = filteredData
      .map((row, idxInFiltered) => {
        // Find real index in gradingData so edits persist
        const realIndex = gradingData.indexOf(row);
        return `<tr>
          <td style="border: 1px solid #63b3ed; padding: 0.5rem;">${row.student}</td>
          <td style="border: 1px solid #63b3ed; padding: 0.5rem;">${row.assignment}</td>
          <td style="border: 1px solid #63b3ed; padding: 0.5rem;">
            <input type="text" value="${row.score}"
              style="width: 70px; background: #111; color: #fff; border: 1px solid #63b3ed; border-radius: 4px; padding: 2px;"
              data-index="${realIndex}" class="score-input"
            />
          </td>
          <td style="border: 1px solid #63b3ed; padding: 0.5rem;">
            <select data-index="${realIndex}" class="status-select"
              style="background: #111; color: #fff; border: 1px solid #63b3ed; border-radius: 4px; padding: 2px;">
              <option value="Pending" ${row.status === "Pending" ? "selected" : ""}>Pending</option>
              <option value="Graded" ${row.status === "Graded" ? "selected" : ""}>Graded</option>
            </select>
          </td>
          <td style="border: 1px solid #63b3ed; padding: 0.5rem;">
            <button class="rubric-btn" data-index="${realIndex}"
              style="background:#111; color:#63b3ed; border:1px solid #63b3ed; border-radius:6px; padding:4px 8px; cursor:pointer;">
              Edit
            </button>
          </td>
        </tr>`;
      })
      .join("");

    document.querySelectorAll(".score-input").forEach((input) => {
      input.addEventListener("input", (e) => {
        const idx = e.target.dataset.index;
        gradingData[idx].score = e.target.value;
      });
    });

    document.querySelectorAll(".status-select").forEach((select) => {
      select.addEventListener("change", (e) => {
        const idx = e.target.dataset.index;
        gradingData[idx].status = e.target.value;
      });
    });

    document.querySelectorAll(".rubric-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const idx = e.target.dataset.index;
        openRubricPopup(Number(idx));
      });
    });
  }

  function populateFilters() {
    const assignmentSet = new Set(gradingData.map(r => r.assignment));
    const statusSet = new Set(gradingData.map(r => r.status));

    const assignmentSelect = document.getElementById("assignment-filter");
    const statusSelect = document.getElementById("status-filter");

    if (assignmentSelect) {
      assignmentSelect.innerHTML =
        `<option value="">All assignments</option>` +
        Array.from(assignmentSet).map(v => `<option value="${v}">${v}</option>`).join("");
      assignmentSelect.addEventListener("change", () => updateTable(document.getElementById("grading-search").value));
    }

    if (statusSelect) {
      statusSelect.innerHTML =
        `<option value="">All statuses</option>` +
        Array.from(statusSet).map(v => `<option value="${v}">${v}</option>`).join("");
      statusSelect.addEventListener("change", () => updateTable(document.getElementById("grading-search").value));
    }
  }

  populateFilters();
  updateTable();

  const searchInput = document.getElementById("grading-search");
  if (searchInput) {
    searchInput.addEventListener("input", (e) => updateTable(e.target.value));
  }
}

/* ===================== RUBRIC POPUP ===================== */
let currentRubricIndex = null;

function openRubricPopup(index) {
  currentRubricIndex = index;

  const popup = document.getElementById("rubric-popup");
  const cats = document.getElementById("rubric-categories");
  const comments = document.getElementById("rubric-comments");

  if (!popup || !cats || !comments) return;

  const saved = gradingData[index].rubric || { checks: [], comments: "" };

  cats.innerHTML = rubricTemplate.map((label, i) => {
    const checked = saved.checks.includes(i) ? "checked" : "";
    return `<label><input type="checkbox" data-r="${i}" ${checked}> ${label}</label><br>`;
  }).join("");

  comments.value = saved.comments || "";

  popup.style.display = "flex";

  const saveBtn = document.getElementById("rubric-save");
  const cancelBtn = document.getElementById("rubric-cancel");

  if (saveBtn) {
    saveBtn.onclick = () => {
      const checks = Array.from(cats.querySelectorAll("input[type=checkbox]"))
        .filter(cb => cb.checked)
        .map(cb => Number(cb.dataset.r));

      gradingData[index].rubric = {
        checks,
        comments: comments.value || ""
      };

      closeRubricPopup();
    };
  }

  if (cancelBtn) cancelBtn.onclick = closeRubricPopup;
}

function closeRubricPopup() {
  const popup = document.getElementById("rubric-popup");
  if (popup) popup.style.display = "none";
  currentRubricIndex = null;
}
</script>

<!-- ===================== END GRADING FEATURE ===================== -->
