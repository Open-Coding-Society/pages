<!-- ===================== GRADING FEATURE ===================== -->

<script>
  // Global feature registry (safe)
  window.PageFeatures = window.PageFeatures || {};

  // âœ… FORCE ENABLE grading
  window.PageFeatures.grading = true;
</script>

<!-- Button Container -->
<div id="grading-button-container" class="grading-button-container"></div>

<!-- Grading Toggle Button -->
<button
  id="grading-toggle-btn"
  class="grading-btn"
  aria-label="Open Grading"
  hidden
>
  ðŸ“Š Grading
</button>

<!-- Grading Panel -->
<aside
  id="grading-panel"
  class="grading-panel"
  tabindex="-1"
  aria-label="Grading Panel"
  hidden
>
  <div class="grading-panel-inner">
    <header class="grading-header">
      <h1>ðŸ“Š Grading Dashboard</h1>
      <button
        id="grading-close-btn"
        class="grading-close-btn"
        aria-label="Close Grading"
      >&times;</button>
    </header>

    <section id="grading-content">
      <em>Loading submissionsâ€¦</em>
    </section>
  </div>
</aside>

<div id="rubric-popup"
  style="position:fixed; inset:0; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:9999;">
  <div style="background:#000; padding:1rem; border:1px solid #63b3ed; border-radius:8px; width:300px; color:white;">
    <h3 style="margin-top:0;">Rubric</h3>
    <div id="rubric-categories">
      <label><input type="checkbox"> Category 1</label><br>
      <label><input type="checkbox"> Category 2</label><br>
      <label><input type="checkbox"> Category 3</label><br>
    </div>
    <textarea id="rubric-comments"
      placeholder="Comments..."
      style="width:100%; margin-top:10px; background:#111; color:white; height:60px; border:1px solid #63b3ed; border-radius:4px;"></textarea>
    <button id="rubric-save"
      style="width:100%; margin-top:10px; background:#111; color:#63b3ed; border:1px solid #63b3ed; padding:4px; border-radius:4px;">
      Save
    </button>
  </div>
</div>

<!-- Rubric Modal -->
<div id="rubric-modal" class="rubric-modal" hidden>
  <div class="rubric-modal-inner" style="background:#111; color:#fff; padding:1rem; border:1px solid #63b3ed; border-radius:8px; width:400px; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1100;">
    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
      <h2>Rubric</h2>
      <button id="rubric-close-btn" style="background:transparent; border:none; color:#fff; font-size:1.2rem; cursor:pointer;">&times;</button>
    </header>
    <div id="rubric-content" class="rubric-content"></div>
  </div>
</div>

<script>
/* ===================== INIT ===================== */
document.addEventListener("DOMContentLoaded", () => {
  if (!window.PageFeatures.grading) return;

  const container = document.getElementById("grading-button-container");
  const toggleBtn = document.getElementById("grading-toggle-btn");

  if (!container || !toggleBtn) return;

  if (!container.contains(toggleBtn)) {
    container.appendChild(toggleBtn);
  }

  toggleBtn.hidden = false;
});

/* ===================== ELEMENTS ===================== */
const gradingToggle = document.getElementById("grading-toggle-btn");
const gradingPanel  = document.getElementById("grading-panel");
const gradingClose  = document.getElementById("grading-close-btn");

/* ===================== OPEN / CLOSE ===================== */
function openGradingPanel() {
  gradingPanel.hidden = false;
  renderGradingTable();
}

function closeGradingPanel() {
  gradingPanel.hidden = true;
}

gradingToggle?.addEventListener("click", openGradingPanel);
gradingClose?.addEventListener("click", closeGradingPanel);

/* ESC to close grading panel */
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && !gradingPanel.hidden) {
    closeGradingPanel();
  }
});

/* ===================== CONTENT ===================== */
const gradingData = [
  { student: "Student A", assignment: "HW1", score: 92, status: "Graded" },
  { student: "Student B", assignment: "HW1", score: 85, status: "Graded" },
  { student: "Student C", assignment: "HW1", score: "â€”", status: "Pending" },
];

/* ===================== RUBRIC TEMPLATE ===================== */
const rubricTemplate = [
  "Correct format",
  "Answered all questions",
  "Code runs without errors",
  "Comments included"
];

const rubricModal = document.getElementById("rubric-modal");
const rubricClose = document.getElementById("rubric-close-btn");
const rubricContent = document.getElementById("rubric-content");

/* ===================== TABLE RENDER + EDITABLE ===================== */
function renderGradingTable() {
  const container = document.getElementById("grading-content");

  container.innerHTML = `
    <input
      type="text"
      id="grading-search"
      placeholder="Search by student..."
      style="width: 100%; padding: 0.5rem; margin-bottom: 1rem; border-radius: 8px; border: 1px solid #63b3ed; background: #000; color: #fff;"
    />
    <table class="grading-table" style="width:100%; border-collapse: collapse; color: #fff;">
      <thead style="background: #111;">
        <tr>
          <th style="border: 1px solid #63b3ed; padding: 0.5rem;">Student</th>
          <th style="border: 1px solid #63b3ed; padding: 0.5rem;">Assignment</th>
          <th style="border: 1px solid #63b3ed; padding: 0.5rem;">Score</th>
          <th style="border: 1px solid #63b3ed; padding: 0.5rem;">Status</th>
          <th style="border: 1px solid #63b3ed; padding: 0.5rem;">Rubric</th>
        </tr>
      </thead>
      <tbody id="grading-tbody"></tbody>
    </table>
  `;

  const tbody = document.getElementById("grading-tbody");

  function updateTable(filter = "") {
    const filteredData = gradingData.filter((row) =>
      row.student.toLowerCase().includes(filter.toLowerCase())
    );

    tbody.innerHTML = filteredData
      .map(
        (row, index) => `<tr>
          <td style="border: 1px solid #63b3ed; padding: 0.5rem;">${row.student}</td>
          <td style="border: 1px solid #63b3ed; padding: 0.5rem;">${row.assignment}</td>
          <td style="border: 1px solid #63b3ed; padding: 0.5rem;">
            <input type="text" value="${row.score}" 
              style="width: 60px; background: #111; color: #fff; border: 1px solid #63b3ed; border-radius: 4px; padding: 2px;"
              data-index="${index}" class="score-input"
            />
          </td>
          <td style="border: 1px solid #63b3ed; padding: 0.5rem;">
            <select data-index="${index}" class="status-select"
              style="background: #111; color: #fff; border: 1px solid #63b3ed; border-radius: 4px; padding: 2px;">
              <option value="Pending" ${row.status === "Pending" ? "selected" : ""}>Pending</option>
              <option value="Graded" ${row.status === "Graded" ? "selected" : ""}>Graded</option>
            </select>
          </td>
        </tr>`
      )
      .join("");

    // Score input listener
    document.querySelectorAll(".score-input").forEach(input => {
      input.addEventListener("input", e => {
        const idx = e.target.dataset.index;
        gradingData[idx].score = e.target.value;
      });
    });

    // Status select listener
    document.querySelectorAll(".status-select").forEach(select => {
      select.addEventListener("change", e => {
        const idx = e.target.dataset.index;
        gradingData[idx].status = e.target.value;
      });
    });

    // Rubric button listener
    document.querySelectorAll(".rubric-btn").forEach(btn => {
      btn.addEventListener("click", e => {
        const idx = e.target.dataset.index;
        openRubricModal(idx);
      });
    });
  }

  updateTable();

  // Live search
  const searchInput = document.getElementById("grading-search");
  searchInput.addEventListener("input", e => {
    updateTable(e.target.value);
  });
}
</script>

<!-- ===================== END GRADING FEATURE ===================== -->
