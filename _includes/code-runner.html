from IPython.display import display, HTML, Javascript
import ipywidgets as widgets
from io import StringIO
import sys
import traceback

class CodeRunner:
    def __init__(self):
        # Create widgets
        self.code_input = widgets.Textarea(
            value='# Write your Python code here\nprint("Hello, World!")\n\nx = 5 + 3\nprint(f"5 + 3 = {x}")',
            placeholder='Type your code here...',
            description='',
            layout=widgets.Layout(width='100%', height='300px')
        )
        
        self.output_area = widgets.Output(
            layout=widgets.Layout(
                width='100%', 
                height='300px',
                border='1px solid #ddd',
                padding='10px',
                overflow='auto'
            )
        )
        
        self.run_button = widgets.Button(
            description='▶ Run Code',
            button_style='success',
            tooltip='Execute code',
            icon='play'
        )
        
        self.clear_button = widgets.Button(
            description='Clear Output',
            button_style='warning',
            tooltip='Clear output'
        )
        
        # Set up button callbacks
        self.run_button.on_click(self.run_code)
        self.clear_button.on_click(self.clear_output)
        
        # Create layout
        button_box = widgets.HBox([self.run_button, self.clear_button])
        self.container = widgets.VBox([
            widgets.HTML('<h3>Python Code Runner</h3>'),
            widgets.HTML('<p style="color: #666;">Editor:</p>'),
            self.code_input,
            button_box,
            widgets.HTML('<p style="color: #666; margin-top: 10px;">Output:</p>'),
            self.output_area
        ])
    
    def run_code(self, b):
        """Execute the code and capture output"""
        self.output_area.clear_output()
        
        # Capture stdout and stderr
        old_stdout = sys.stdout
        old_stderr = sys.stderr
        
        redirected_output = StringIO()
        redirected_error = StringIO()
        
        sys.stdout = redirected_output
        sys.stderr = redirected_error
        
        try:
            # Execute the code
            exec(self.code_input.value, globals())
            
            # Display output
            with self.output_area:
                output = redirected_output.getvalue()
                error = redirected_error.getvalue()
                
                if output:
                    print(output)
                if error:
                    print("STDERR:", error)
                    
                if not output and not error:
                    print("✓ Code executed successfully (no output)")
                    
        except Exception as e:
            with self.output_area:
                print("❌ ERROR:")
                print(traceback.format_exc())
        
        finally:
            # Restore stdout and stderr
            sys.stdout = old_stdout
            sys.stderr = old_stderr
    
    def clear_output(self, b):
        """Clear the output area"""
        self.output_area.clear_output()
    
    def display(self):
        """Display the widget"""
        display(self.container)

# Create and display the code runner
runner = CodeRunner()
runner.display()
