---
layout: post
---

{% assign shared = site.data.cs %}
{% assign course = site.data[page.course] %}
{% assign units = page.units | split: ',' %}
{% assign posts = null | compact %}
{% assign posts = posts | concat: site.posts | concat: site.pages %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% include pwa-head.html %}

<style>
  body {
    background: #0a0a0a;
  }

  .timeline-header {
    margin-bottom: 32px;
  }

  .timeline-header h1 {
    color: #ffffff;
    font-size: 2.5rem;
    margin-bottom: 8px;
  }

  .timeline-header-description {
    color: #999999;
    margin-bottom: 24px;
  }

  .timeline-filters {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .filter-btn {
    padding: 8px 16px;
    background: transparent;
    border: 1px solid #2a2a2a;
    border-radius: 6px;
    color: #e0e0e0;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
  }

  .filter-btn:hover {
    background: #1a1a1a;
  }

  .filter-btn.active {
    background: #1a1a1a;
    border-color: #60a5fa;
    color: #60a5fa;
  }

  .leaderboard-link {
    text-decoration: none;
    background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    color: #ffffff !important;
    border-color: #60a5fa;
    font-weight: 500;
  }

  .leaderboard-link:hover {
    background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
  }

  .timeline-container {
    margin-top: 32px;
  }

  .sprint-card {
    background: #111111;
    border: 1px solid #1f1f1f;
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 24px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.25);
  }

  .sprint-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
    flex-wrap: wrap;
    border-bottom: 1px solid #1f2338;
    padding-bottom: 20px;
    margin-bottom: 24px;
  }

  .sprint-title {
    margin: 0;
    font-size: 1.75rem;
    color: #f8fafc;
  }

  .sprint-meta {
    color: #9ca3af;
    font-size: 0.95rem;
  }

  .sprint-controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
  }

  .sprint-card.collapsed .sprint-toggle-icon {
    transform: rotate(0deg);
  }

  .sprint-toggle-icon {
    transition: transform 0.2s;
    display: inline-flex;
  }

  .sprint-weeks {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .sprint-card.collapsed .sprint-weeks {
    display: none;
  }

  .sprint-card.collapsed .sprint-title {
    color: #cbd5f5;
  }

  .week-card {
    background: #0f0f0f;
    border: 1px solid #222222;
    border-radius: 12px;
    margin-bottom: 16px;
    transition: all 0.2s;
    overflow: hidden;
  }

  .week-card:hover {
    border-color: #2a2a2a;
  }

  .week-content-wrapper {
    display: flex;
    gap: 24px;
  }

  .week-main-content {
    flex: 1;
  }

  .week-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .week-indicator {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .week-circle {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: #1a1a1a;
    border: 2px solid #2a2a2a;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #60a5fa;
    font-weight: 600;
    font-size: 14px;
  }

  .week-connector {
    width: 1px;
    height: 32px;
    background: #222222;
    margin-top: 8px;
  }

  .week-card:last-child .week-connector {
    display: none;
  }

  .week-actions {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .week-title-group h3 {
    color: #ffffff;
    font-size: 1.25rem;
    margin: 0 0 4px 0;
  }

  .week-sprint {
    color: #60a5fa;
    font-size: 14px;
  }

  .week-actions {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .completion-badge {
    background: transparent;
    border: 1px solid #2a2a2a;
    color: #cccccc;
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 13px;
  }

  .progression-btn {
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    color: #60a5fa;
    padding: 6px 14px;
    border-radius: 4px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .progression-btn:hover,
  .progression-btn:focus-visible {
    border-color: #60a5fa;
    color: #93c5fd;
    background: #151515;
    outline: none;
  }

  .progress-bar-container {
    width: 100%;
    height: 8px;
    background: #1a1a1a;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 16px;
  }

  .progress-bar-fill {
    height: 100%;
    background: #60a5fa;
    transition: width 0.3s ease;
    width: 0%;
  }

  .items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 12px;
    margin-bottom: 16px;
  }

  .item-card {
    padding: 12px;
    background: #151515;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
    transition: background 0.2s;
  }

  .item-card:hover {
    background: #1a1a1a;
  }

  .item-content {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
  }

  .completion-toggle {
    background: none;
    border: none;
    padding: 0;
    margin: 0;
    cursor: pointer;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
  }

  .item-link {
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
    flex: 1;
    min-width: 0;
  }

  .status-icon {
    flex-shrink: 0;
    width: 16px;
    height: 16px;
    font-size: 16px;
  }

  .status-icon.completed {
    color: #60a5fa;
  }

  .status-icon.incomplete {
    color: #444444;
  }

  .type-icon {
    flex-shrink: 0;
    width: 16px;
    height: 16px;
  }

  .type-icon.lesson {
    color: #60a5fa;
  }

  .type-icon.assignment {
    color: #f59e0b;
  }

  .item-title {
    color: #e0e0e0;
    flex: 1;
    font-size: 14px;
  }

  .item-card.completed .item-title {
    color: #999999;
  }

  .assignment-due {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #f59e0b;
    font-size: 14px;
    margin-top: 8px;
  }

  .load-more {
    text-align: center;
    margin-top: 24px;
  }

  .load-more-btn {
    padding: 10px 24px;
    background: transparent;
    border: 1px solid #2a2a2a;
    color: #60a5fa;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .load-more-btn:hover {
    background: #1a1a1a;
    color: #93c5fd;
  }

  @media (max-width: 768px) {
    .items-grid {
      grid-template-columns: 1fr;
    }

    .week-content-wrapper {
      gap: 16px;
    }

    .week-circle {
      width: 48px;
      height: 48px;
      font-size: 12px;
    }

    .week-actions {
      justify-content: flex-start;
    }
  }

  /* Certificate System Styles */
  .certificate-badge {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    box-shadow: 0 2px 8px rgba(96, 165, 250, 0.3);
    z-index: 1;
  }

  .week-card.clickable {
    cursor: pointer;
  }

  .week-card.clickable:hover {
    border-color: #60a5fa;
    box-shadow: 0 0 12px rgba(96, 165, 250, 0.2);
  }

  /* Progression Modal */
  #progression-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.85);
    z-index: 1000;
    padding: 20px;
    overflow-y: auto;
  }

  #progression-modal > div {
    max-width: 600px;
    margin: 40px auto;
    background: #0f0f0f;
    border: 1px solid #2a2a2a;
    border-radius: 12px;
    padding: 32px;
    position: relative;
  }

  #progression-modal .close-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: transparent;
    border: none;
    color: #e6eef8; /* bright so it's visible on dark background */
    font-size: 24px;
    cursor: pointer;
    z-index: 2050; /* ensure it floats above modal content */
  }

  /* Certificate list & certificate modal close button styles */
  #certificate-list-modal .close-btn {
    position: absolute;
    top: 18px;
    right: 18px;
    background: transparent;
    border: none;
    color: #e6eef8;
    font-size: 22px;
    cursor: pointer;
    z-index: 2050;
  }

  /* Add similar X button style for the certificate modal */
  #certificate-modal .close-btn {
    position: absolute;
    top: 18px;
    right: 18px;
    background: transparent;
    border: none;
    color: #333;
    font-size: 26px;
    cursor: pointer;
    z-index: 2050;
  }

  #progression-modal h2 {
    color: #ffffff;
    margin-bottom: 8px;
  }

  #progression-modal .week-theme {
    color: #60a5fa;
    margin-bottom: 24px;
  }

  #modal-progress-fill {
    height: 100%;
    background: #60a5fa;
    width: 0%;
    transition: width 0.3s;
  }

  .progression-task {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #151515;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
    margin-bottom: 8px;
  }

  .progression-task input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #60a5fa;
  }

  .progression-task label {
    color: #e0e0e0;
    flex: 1;
    cursor: pointer;
  }

  .task-number {
    color: #666;
    font-size: 14px;
  }

  #view-certificate-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s;
    margin-top: 24px;
  }

  #view-certificate-btn:hover {
    transform: scale(1.02);
  }

  /* Certificate Modal */
  #certificate-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 2000;
    padding: 20px;
    overflow-y: auto;
  }

  #certificate-modal .action-bar {
    position: sticky;
    top: 0;
    background: rgba(255,255,255,0.95);
    padding: 16px;
    text-align: center;
    border-bottom: 1px solid #ddd;
    z-index: 10;
  }

  #certificate-modal .action-btn {
    padding: 10px 20px;
    background: #0077b5;
    color: white;
    border: none;
    border-radius: 6px;
    margin: 0 8px;
    cursor: pointer;
  }

  #certificate-modal .secondary-btn {
    background: white;
    color: #333;
    border: 1px solid #ccc;
  }

  #certificate-content {
    max-width: 1000px;
    margin: 40px auto;
    background: #fdfaf1;
    padding: 90px 80px;
    border: 3px solid #d4a574;
    position: relative;
    font-family: 'Crimson Text', serif;
    color: #1f2937;
  }

  #certificate-content::before {
    content: '';
    position: absolute;
    top: 18px;
    left: 18px;
    right: 18px;
    bottom: 18px;
    border: 1px solid rgba(212, 165, 116, 0.7);
    pointer-events: none;
  }

  #certificate-content > div {
    position: relative;
    z-index: 1;
  }

  .certificate-heading {
    text-align: center;
    margin-bottom: 40px;
  }

  .certificate-emblem {
    width: 110px;
    height: 110px;
    border-radius: 50%;
    background: #111827;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 24px;
    border: 3px solid #d4a574;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }

  #certificate-logo {
    width: 80px;
    height: 80px;
    object-fit: contain;
  }

  #certificate-content .header-text {
    font-size: 14px;
    letter-spacing: 0.35em;
    text-transform: uppercase;
    color: #505766;
    font-family: 'Libre Baskerville', serif;
    margin-bottom: 12px;
  }

  #certificate-content .certify-text {
    font-size: 30px;
    color: #1f2937;
    font-family: 'Libre Baskerville', serif;
    margin-bottom: 8px;
  }

  .certificate-subtitle {
    text-transform: uppercase;
    letter-spacing: 0.25em;
    font-size: 13px;
    color: #9ca3af;
  }

  #certificate-student-name {
    font-size: 62px;
    color: #111827;
    font-family: 'Libre Baskerville', serif;
    font-weight: 700;
    border: none;
    outline: none;
    display: block;
    cursor: text;
    text-align: center;
    margin: 32px auto 40px;
    width: 100%;
  }

  #certificate-student-name:empty::before {
    content: 'Your Name';
    color: #d1d5db;
  }

  #certificate-content .achievement-text {
    text-align: center;
    font-size: 22px;
    color: #374151;
    max-width: 720px;
    margin: 0 auto 48px;
    line-height: 1.7;
  }

  .skill-focus-pill {
    text-align: center;
    margin-bottom: 32px;
  }

  .skill-focus-pill span {
    display: inline-block;
    padding: 6px 20px;
    border: 1px solid #d4a574;
    border-radius: 999px;
    font-size: 16px;
    color: #92400e;
    background: rgba(212, 165, 116, 0.18);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  #certificate-date {
    text-align: center;
    font-size: 18px;
    color: #6b7280;
    font-style: italic;
    margin-bottom: 40px;
  }

  .certificate-divider {
    width: 60%;
    height: 1px;
    background: transparent;
    margin: 0 auto 48px;
  }

  #certificate-content .signature-section {
    display: flex;
    justify-content: center;
    margin-top: 32px;
  }

  #certificate-content .signature {
    text-align: center;
    max-width: 320px;
  }

  #certificate-content .signature-name {
    font-size: 30px;
    font-style: italic;
    color: #1f2937;
    font-family: 'Libre Baskerville', serif;
    margin-bottom: 8px;
  }

  #certificate-content .signature-line {
    border-top: 2px solid #9ca3af;
    padding-top: 8px;
    margin-bottom: 12px;
  }

  #certificate-content .signature-title {
    font-family: 'Libre Baskerville', serif;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
  }

  #certificate-content .signature-subtitle {
    color: #4b5563;
    margin: 2px 0 0 0;
  }

  /* Certificate List Modal */
  #certificate-list-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 1500;
    padding: 20px;
    overflow-y: auto;
  }

  #certificate-list-modal > div {
    max-width: 600px;
    margin: 40px auto;
    background: #0f0f0f;
    border: 1px solid #2a2a2a;
    border-radius: 12px;
    padding: 32px;
    position: relative;
  }

  #certificate-list-modal .close-btn {
    position: absolute;
    top: 18px;
    right: 18px;
    background: transparent;
    border: none;
    color: #e6eef8;
    font-size: 22px;
    cursor: pointer;
    z-index: 2050;
  }

  #certificate-list-modal h2 {
    color: #ffffff;
    margin-bottom: 24px;
  }

  #certificate-list button {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s;
    margin-bottom: 12px;
  }

  #certificate-list button:hover {
    transform: scale(1.02);
  }

  #certificate-skills {
    margin-top: 48px;
    padding-top: 32px;
    border-top: 1px solid #d1d5db;
  }

  .skills-heading {
    text-align: center;
    color: #0b0d17 !important;
    font-family: 'Libre Baskerville', serif;
    font-weight: 600;
    letter-spacing: 0.05em;
    margin-bottom: 16px;
  }

  #skills-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
  }

  .skill-tag {
    padding: 6px 16px;
    border: 1px solid #d4a574;
    border-radius: 20px;
    color: #1f2937;
    font-family: 'Crimson Text', serif;
    font-size: 14px;
    margin: 4px;
    background: rgba(212, 165, 116, 0.1);
  }

  @media (max-width: 768px) {
    #certificate-content {
      padding: 40px 20px;
    }

    #certificate-student-name {
      font-size: 36px;
    }

    #certificate-content .signature-section {
      flex-direction: column;
      gap: 16px;
    }
  }

  .leaderboard-container {
 background: #111111;
 border: 1px solid #1f1f1f;
 border-radius: 16px;
 padding: 32px;
 margin-bottom: 24px;
}


.leaderboard-header {
 display: flex;
 justify-content: space-between;
 align-items: center;
 margin-bottom: 24px;
 flex-wrap: wrap;
 gap: 16px;
}


.leaderboard-header h2 {
 color: #ffffff;
 margin: 0;
}


.leaderboard-controls {
 display: flex;
 gap: 12px;
}


.leaderboard-stats-overview {
 display: grid;
 grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
 gap: 16px;
 margin-bottom: 32px;
}


.stat-card {
 background: #0f0f0f;
 border: 1px solid #2a2a2a;
 border-radius: 12px;
 padding: 20px;
 display: flex;
 align-items: center;
 gap: 16px;
 transition: all 0.2s;
}


.stat-card:hover {
 border-color: #60a5fa;
 transform: translateY(-2px);
}


.stat-icon {
 font-size: 32px;
 flex-shrink: 0;
}


.stat-content {
 flex: 1;
}


.stat-label {
 color: #999999;
 font-size: 13px;
 margin-bottom: 4px;
}


.stat-value {
 color: #ffffff;
 font-size: 24px;
 font-weight: 600;
}


.leaderboard-table-container {
 overflow-x: auto;
 border-radius: 8px;
 border: 1px solid #2a2a2a;
}


.leaderboard-table {
 width: 100%;
 border-collapse: collapse;
}


.leaderboard-table thead {
 background: #0f0f0f;
}


.leaderboard-table th {
 padding: 16px;
 text-align: left;
 color: #60a5fa;
 font-weight: 600;
 border-bottom: 2px solid #2a2a2a;
}


.leaderboard-table th.sortable {
 cursor: pointer;
 user-select: none;
}


.leaderboard-table th.sortable:hover {
 color: #93c5fd;
}


.leaderboard-table tbody tr {
 border-bottom: 1px solid #1f1f1f;
 transition: background 0.2s;
}


.leaderboard-table tbody tr:hover {
 background: #0f0f0f;
}


.leaderboard-table tbody tr.current-user {
 background: rgba(96, 165, 250, 0.1);
 border-left: 3px solid #60a5fa;
}


.leaderboard-table td {
 padding: 16px;
 color: #e0e0e0;
}


.rank-cell {
 font-weight: 700;
 font-size: 18px;
}


.rank-cell.top-3 {
 color: #fbbf24;
}


.student-cell {
 display: flex;
 align-items: center;
 gap: 12px;
}


.student-avatar {
 width: 36px;
 height: 36px;
 border-radius: 50%;
 background: linear-gradient(135deg, #60a5fa, #3b82f6);
 display: flex;
 align-items: center;
 justify-content: center;
 color: white;
 font-weight: 600;
}


.badges-cell {
 display: flex;
 gap: 4px;
}


.badge-icon {
 font-size: 20px;
 opacity: 0.8;
 transition: opacity 0.2s;
}


.badge-icon:hover {
 opacity: 1;
 transform: scale(1.2);
}


/* Analytics Dashboard */
.analytics-dashboard {
 background: #111111;
 border: 1px solid #1f1f1f;
 border-radius: 16px;
 padding: 32px;
}


.analytics-dashboard h2 {
 color: #ffffff;
 margin-bottom: 24px;
}


.charts-grid {
 display: grid;
 grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
 gap: 24px;
}


.chart-card {
 background: #0f0f0f;
 border: 1px solid #2a2a2a;
 border-radius: 12px;
 padding: 24px;
}


.chart-card h3 {
 color: #ffffff;
 margin: 0 0 20px 0;
 font-size: 16px;
}


#quest-timeline {
 max-height: 300px;
 overflow-y: auto;
}


.timeline-item {
 display: flex;
 gap: 16px;
 margin-bottom: 16px;
 padding-bottom: 16px;
 border-bottom: 1px solid #1f1f1f;
}


.timeline-item:last-child {
 border-bottom: none;
}


.timeline-marker {
 width: 12px;
 height: 12px;
 border-radius: 50%;
 background: #60a5fa;
 margin-top: 4px;
 flex-shrink: 0;
}


.timeline-content {
 flex: 1;
}


.timeline-title {
 color: #e0e0e0;
 font-weight: 600;
 margin-bottom: 4px;
}


.timeline-date {
 color: #999999;
 font-size: 13px;
}


#activity-heatmap {
 display: grid;
 grid-template-columns: repeat(7, 1fr);
 gap: 4px;
 max-width: 400px;
}


.heatmap-cell {
 aspect-ratio: 1;
 border-radius: 2px;
 background: #1a1a1a;
 transition: all 0.2s;
 cursor: pointer;
}


.heatmap-cell.level-0 { background: #1a1a1a; }
.heatmap-cell.level-1 { background: #0e4429; }
.heatmap-cell.level-2 { background: #006d32; }
.heatmap-cell.level-3 { background: #26a641; }
.heatmap-cell.level-4 { background: #39d353; }


.heatmap-cell:hover {
 transform: scale(1.1);
 box-shadow: 0 0 8px rgba(96, 165, 250, 0.5);
}


@media (max-width: 768px) {
 .charts-grid {
   grid-template-columns: 1fr;
 }
  .leaderboard-stats-overview {
   grid-template-columns: repeat(2, 1fr);
 }
}


</style>

<div class="timeline-header">
  <h1>Course Timeline</h1>  
  <div class="timeline-filters">
    <button class="filter-btn active" data-filter="all">
      <i class="fas fa-filter"></i> All Items
    </button>
    <button class="filter-btn" data-filter="lessons">
      Lessons Only
    </button>
    <button class="filter-btn" data-filter="assignments">
      Assignments Only
    </button>
    <button class="filter-btn" data-filter="incomplete">
      Incomplete Only
    </button>
    <a href="{{ site.baseurl }}/leaderboard?course={{ page.course }}" class="filter-btn leaderboard-link">
      <i class="fas fa-trophy"></i> View Leaderboard
    </a>
  </div>
</div>

<div class="timeline-container">
  {% for unit in units %}
    {% assign unitKey = "Sprint" | append: unit %}
    {% assign unitData = course[unitKey] %}
    {% assign courseUnit = course[unitKey] %}
    {% assign start = unitData.start %}
    {% assign end = unitData.end %}

    {% if courseUnit.shared %}
      {% assign unitData = shared[courseUnit.shared] %}
    {% endif %}

    <div class="sprint-card collapsed" data-sprint="{{ unitKey }}">
      <div class="sprint-header">
        <div>
          <p class="sprint-meta">{{ unitKey }}</p>
          <h2 class="sprint-title">{{ unitData.title }}</h2>
          {% if unitData.description %}
            <p class="sprint-meta">{{ unitData.description }}</p>
          {% endif %}
        </div>
        <div class="sprint-controls">
          <div class="completion-badge">{{ start }} - {{ end }} Weeks</div>
          <button class="progression-btn sprint-toggle-btn" type="button" aria-expanded="false">
            <span class="sprint-toggle-icon">â–¾</span> View Weeks
          </button>
        </div>
      </div>

      <div class="sprint-weeks">
        <div class="sprint-body">
          <h3 style="margin:0 0 12px 0; font-weight:700; color:#cbd5f5;">{{ unitKey }} â€” {{ unitData.title }}</h3>

          {% for index in (start..end) %}
            {% assign entries = null | compact %}
            {% assign totalItems = 0 %}

            {% for post in posts %}
              {% if post.courses[page.course] %}
                {% comment %}Skip Jekyll auto-generated notebook markdown files (prefer original .ipynb files){% endcomment %}
                {% unless post.path contains "_IPYNB_2_.md" %}
                  {% comment %}Skip files with multiple courses - they should use course-specific versions{% endcomment %}
                  {% assign course_count = 0 %}
                  {% for course in post.courses %}
                    {% assign course_count = course_count | plus: 1 %}
                  {% endfor %}
                  {% if course_count == 1 %}
                  {% assign week = post.courses[page.course].week | plus: 0 %}
                  {% if week == index %}
                    {% if post.assignment == true %}
                      {% assign itemType = "assignment" %}
                    {% else %}
                      {% assign itemType = "lesson" %}
                    {% endif %}
                    {% assign entry = post.title | append: "||" | append: post.url | append: "||" | append: itemType %}
                    {% assign entries = entries | push: entry %}
                    {% assign totalItems = totalItems | plus: 1 %}
                  {% endif %}
                  {% endif %}
                {% endunless %}
              {% endif %}
            {% endfor %}

          {% if entries.size > 0 %}
            <div class="week-card clickable" data-week="{{ index }}" data-sprint="{{ unitKey }}">
              <div class="week-content-wrapper">
                <div class="week-indicator">
                  <div class="week-circle">W{{ index }}</div>
                  <div class="week-connector"></div>
                </div>

                <div class="week-main-content">
                  <div class="week-header">
                    <div class="week-title-group">
                      <h3 data-week-title>Week {{ index }}</h3>
                    </div>
                    <div class="week-actions">
                      <div class="completion-badge">
                        {{ completedItems }}/{{ totalItems }} Complete
                      </div>
                      <button class="progression-btn" type="button">
                        Progress & Certificates
                      </button>
                    </div>
                  </div>

                  <div class="progress-bar-container">
                    {% if totalItems > 0 %}
                      {% assign progress = completedItems | times: 100 | divided_by: totalItems %}
                    {% else %}
                      {% assign progress = 0 %}
                    {% endif %}
                    <div class="progress-bar-fill" data-progress="{{ progress }}"></div>
                  </div>

                  <div class="items-grid">
                    {% for entry in entries %}
                      {% assign parts = entry | split: "||" %}
                      {% if parts[2] == "assignment" %}
                        {% assign isAssignment = true %}
                        {% assign itemType = "assignment" %}
                      {% else %}
                        {% assign isAssignment = false %}
                        {% assign itemType = "lesson" %}
                      {% endif %}

                      <div class="item-card" data-type="{{ itemType }}" data-item-id="{{ parts[1] }}">
                        <div class="item-content">
                          <button class="completion-toggle">
                            <i class="fas fa-circle status-icon incomplete"></i>
                          </button>
                          <a href="{{ site.baseurl }}{{ parts[1] }}" class="item-link">
                            {% if isAssignment %}
                              <i class="fas fa-file-alt type-icon assignment"></i>
                            {% else %}
                              <i class="fas fa-code type-icon lesson"></i>
                            {% endif %}
                            <span class="item-title">{{ parts[0] }}</span>
                          </a>
                        </div>
                      </div>
                    {% endfor %}
                  </div>

                  {% assign assignmentCount = 0 %}
                  {% for entry in entries %}
                    {% assign parts = entry | split: "||" %}
                    {% if parts[2] == "assignment" %}
                      {% assign assignmentCount = assignmentCount | plus: 1 %}
                    {% endif %}
                  {% endfor %}

                  {% if assignmentCount > 0 %}
                    <div class="assignment-due">
                      <i class="fas fa-calendar"></i>
                      <span>{{ assignmentCount }} assignment{% if assignmentCount > 1 %}s{% endif %} due</span>
                    </div>
                  {% endif %}

                  <div class="week-skills-row" data-week-skills></div>
                </div>
              </div>
            </div>
          {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<!-- ============================= -->
<!--   PROGRESSION MODAL (DARK)   -->
<!-- ============================= -->
<div id="progression-modal">
  <div>
    <button id="close-progression-modal" class="close-btn" aria-label="Close week progress modal">&times;</button>
    <h2>Week <span id="modal-week-number"></span> Progress</h2>
    <p class="week-theme" id="modal-week-theme"></p>

    <div class="progress-bar-container" style="margin-bottom: 16px;">
      <div id="modal-progress-fill" style="height: 8px; background: #60a5fa; width: 0%; transition: width 0.3s;"></div>
    </div>

    <div id="task-list"></div>

    <div id="certificate-status" style="margin-top: 24px;"></div>
  </div>
</div>

<!-- ============================= -->
<!--   CERTIFICATE LIST MODAL      -->
<!-- ============================= -->
<div id="certificate-list-modal">
  <div>
    <button id="close-certificate-list-modal" class="close-btn" aria-label="Close certificate list modal">&times;</button>
    <h2>Week <span id="list-modal-week-number"></span> Certificates</h2>
    <div id="certificate-list"></div>
  </div>
</div>

<!-- ============================= -->
<!--     CERTIFICATE MODAL         -->
<!-- ============================= -->
<div id="certificate-modal">
  <!-- Top-right X to close the modal quickly -->
  <button id="close-certificate-modal-x" class="close-btn" aria-label="Close certificate modal">&times;</button>

  <div class="action-bar">
    <button id="download-certificate-btn" class="action-btn">Download PNG</button>
    <button id="print-certificate-btn" class="action-btn secondary-btn">Print</button>
    <button id="linkedin-share-btn" class="action-btn">Add to LinkedIn</button>
    <button id="close-certificate-modal" class="action-btn secondary-btn">Close</button>
  </div>

  <div id="certificate-content">
    <div>
      <div class="certificate-heading">
        <div class="certificate-emblem">
          <img id="certificate-logo" src="{{ '/assets/images/ocs-logo.png' | relative_url }}" alt="Open Coding Society Logo">
        </div>
        <div class="header-text">Open Coding Society</div>
        <div class="certify-text">Certificate of Completion</div>
        <div class="certificate-subtitle">Presented to</div>
      </div>

      <div
        contenteditable="true"
        id="certificate-student-name"
      ></div>

      <div class="achievement-text">
        Has successfully completed the module:
        <br><strong id="certificate-week-theme"></strong><br>
        as part of the course<br>
        <strong id="certificate-course-name"></strong>.
      </div>

      <div class="skill-focus-pill">
        <span id="certificate-skill-focus">Skill Focus</span>
      </div>

      <div id="certificate-date"></div>

      <div class="certificate-divider"></div>

      <!-- Skills -->
      <div id="certificate-skills">
        <h3 class="skills-heading">Skills Demonstrated</h3>
        <div id="skills-container"></div>
      </div>

      <!-- Signature -->
      <div class="signature-section">
        <div class="signature">
          <div class="signature-line"></div>
          <div class="signature-name">John Mortensen</div>
          <div class="signature-title">Course Instructor</div>
          <div class="signature-subtitle">Open Coding Society</div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Embed course skill library as application/json (avoid problematic Liquid default with {} ) -->
<script id="course-skill-lib-json" type="application/json">
  {{ site.data.certificate_skills | jsonify }}
</script>

<script>
  // Completion tracking (course-specific)
  const CURRENT_COURSE = '{{ page.course }}';
  const STORAGE_KEY = `${CURRENT_COURSE}-lesson-completion`;

  const LEADERBOARD_KEY = `${CURRENT_COURSE}-leaderboard`;
const USER_STATS_KEY = `${CURRENT_COURSE}-user-stats`;


// Enhanced user stats structure
function initializeUserStats() {
 const defaultStats = {
   username: localStorage.getItem('student-username') || 'Anonymous',
   totalCompleted: 0,
   totalItems: 0,
   currentStreak: 0,
   longestStreak: 0,
   lastActivityDate: null,
   weeklyProgress: {}, // { weekNum: { completed: X, total: Y, completedDate: timestamp } }
   challengeScores: {}, // { challengeId: { score: X, attempts: Y, bestTime: Z } }
   badges: [], // Achievement badges
   xp: 0
 };
  try {
   const stored = localStorage.getItem(USER_STATS_KEY);
   return stored ? { ...defaultStats, ...JSON.parse(stored) } : defaultStats;
 } catch (e) {
   return defaultStats;
 }
}


function saveUserStats(stats) {
 localStorage.setItem(USER_STATS_KEY, JSON.stringify(stats));
 updateLeaderboard(stats);
}


// Track completion with enhanced metrics
function enhancedToggleCompletion(button) {
 toggleCompletion(button); // Original function
  const stats = initializeUserStats();
 const weekCard = button.closest('.week-card');
 const weekNum = extractWeekNumber(weekCard);
  // Update stats
 updateStreaks(stats);
 updateWeeklyProgress(stats, weekNum);
 calculateXP(stats);
  saveUserStats(stats);
 refreshLeaderboardDisplay();
}


function updateStreaks(stats) {
 const today = new Date().toDateString();
 const lastActivity = stats.lastActivityDate;
  if (lastActivity === today) {
   return; // Already counted today
 }
  const yesterday = new Date();
 yesterday.setDate(yesterday.getDate() - 1);
  if (lastActivity === yesterday.toDateString()) {
   stats.currentStreak++;
 } else if (lastActivity !== today) {
   stats.currentStreak = 1;
 }
  stats.longestStreak = Math.max(stats.longestStreak, stats.currentStreak);
 stats.lastActivityDate = today;
}


function calculateXP(stats) {
 // XP calculation based on different metrics
 const completionXP = stats.totalCompleted * 10;
 const streakBonus = stats.currentStreak * 5;
 const weekCompletionBonus = Object.values(stats.weeklyProgress)
   .filter(week => week.completed === week.total).length * 50;
  stats.xp = completionXP + streakBonus + weekCompletionBonus;
}


function updateWeeklyProgress(stats, weekNum) {
 if (!stats.weeklyProgress) stats.weeklyProgress = {};
  const weekCard = getWeekCardElement(weekNum);
 if (!weekCard) return;
  const items = weekCard.querySelectorAll('.item-card');
 const completed = Array.from(items).filter(i => i.classList.contains('completed')).length;
  stats.weeklyProgress[weekNum] = {
   completed,
   total: items.length,
   completedDate: completed === items.length ? new Date().toISOString() : null
 };
}

  // Load the skill library from the JSON script tag so the JS file itself contains no raw Liquid tokens
  let COURSE_SKILL_LIBRARY = {};
  try {
    const el = document.getElementById('course-skill-lib-json');
    if (el && el.textContent) {
      COURSE_SKILL_LIBRARY = JSON.parse(el.textContent);
    }
  } catch (e) {
    console.warn('Unable to parse COURSE_SKILL_LIBRARY, falling back to empty object', e);
    COURSE_SKILL_LIBRARY = {};
  }

  // Load completion data from localStorage
  function loadCompletionData() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      return stored ? JSON.parse(stored) : {};
    } catch (e) {
      console.error('Error loading completion data:', e);
      return {};
    }
  }
  
  // Save completion data to localStorage
  function saveCompletionData(data) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
      console.error('Error saving completion data:', e);
    }
  }
  
  // Toggle completion status (enhanced with stats tracking)
  function toggleCompletion(button) {
    try {
      const itemCard = button.closest('.item-card');
      if (!itemCard) {
        console.error('Could not find item card');
        return;
      }
      
      const itemId = itemCard.dataset.itemId;
      const completionData = loadCompletionData();
      const isCompleted = completionData[itemId] || false;
      
      // Toggle status
      completionData[itemId] = !isCompleted;
      saveCompletionData(completionData);
      
      // Update UI
      updateItemUI(itemCard, !isCompleted);
      updateProgressBars();
     
     const stats = initializeUserStats();
     const weekCard = button.closest('.week-card');
     const weekNum = extractWeekNumber(weekCard);
    
     // Recalculate totals
     const allItems = document.querySelectorAll('.item-card');
     stats.totalItems = allItems.length;
     stats.totalCompleted = Array.from(allItems).filter(c => c.classList.contains('completed')).length;
    
     updateStreaks(stats);
     updateWeeklyProgress(stats, weekNum);
     calculateXP(stats);
     saveUserStats(stats);
    
     refreshLeaderboardDisplay();
     initializeCharts();

    } catch (error) {
      console.error('Error in toggleCompletion:', error);
    }
  }
  
  // Update item UI based on completion status
  function updateItemUI(itemCard, isCompleted) {
    const statusIcon = itemCard.querySelector('.status-icon');
    
    if (isCompleted) {
      statusIcon.classList.remove('fa-circle', 'incomplete');
      statusIcon.classList.add('fa-circle-check', 'completed');
      itemCard.classList.add('completed');
    } else {
      statusIcon.classList.remove('fa-circle-check', 'completed');
      statusIcon.classList.add('fa-circle', 'incomplete');
      itemCard.classList.remove('completed');
    }
  }
  
  // Update progress bars for all weeks
  function updateProgressBars() {
    const weekCards = document.querySelectorAll('.week-card');
    
    weekCards.forEach(weekCard => {
      const itemCards = weekCard.querySelectorAll('.item-card');
      const completionBadge = weekCard.querySelector('.completion-badge');
      const progressFill = weekCard.querySelector('.progress-bar-fill');
      
      let totalItems = itemCards.length;
      let completedItems = 0;
      
      itemCards.forEach(card => {
        if (card.classList.contains('completed')) {
          completedItems++;
        }
      });
      
      const progress = totalItems > 0 ? (completedItems / totalItems) * 100 : 0;
      
      // Update badge
      if (completionBadge) {
        completionBadge.textContent = `${completedItems}/${totalItems} Complete`;
      }
      
      // Update progress bar
      if (progressFill) {
        progressFill.style.width = `${progress}%`;
      }
    });
  }
  
  // Initialize completion states on page load
  function initializeCompletion() {
    const completionData = loadCompletionData();
    const itemCards = document.querySelectorAll('.item-card');
    
    itemCards.forEach(card => {
      const itemId = card.dataset.itemId;
      const isCompleted = completionData[itemId] || false;
      updateItemUI(card, isCompleted);
      
      // Add click event listener to the completion toggle button
      const toggleButton = card.querySelector('.completion-toggle');
      if (toggleButton) {
        toggleButton.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          toggleCompletion(this);
        });
      }
    });
    
    updateProgressBars();
  }
  
  // Filter functionality
  const filterBtns = document.querySelectorAll('.filter-btn');
  
  function applyFilters() {
    const itemCards = document.querySelectorAll('.item-card');
    const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
    
    itemCards.forEach(card => {
      const type = card.dataset.type;
      const isCompleted = card.classList.contains('completed');
      
      if (activeFilter === 'all') {
        card.style.display = 'block';
      } else if (activeFilter === 'lessons' && type === 'lesson') {
        card.style.display = 'block';
      } else if (activeFilter === 'assignments' && type === 'assignment') {
        card.style.display = 'block';
      } else if (activeFilter === 'incomplete' && !isCompleted) {
        card.style.display = 'block';
      } else {
        card.style.display = 'none';
      }
    });
  }
  
  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      // Update active state
      filterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      // Apply filters
      applyFilters();
    });
  });
  
  // Initialize progress bars from data attributes
  function initializeProgressBars() {
    const progressBars = document.querySelectorAll('.progress-bar-fill');
    progressBars.forEach(bar => {
      const progress = bar.dataset.progress || 0;
      bar.style.width = `${progress}%`;
    });
  }
  
  let currentModalWeekNumber = null;
  let activeCertificateProfile = null;

  const COURSE_LABELS = {
    csp: 'Computer Science Principles',
    csa: 'Computer Science A',
    csse: 'Computer Science and Software Engineering'
  };

  // Extract week number from week card
  function extractWeekNumber(weekCard) {
    const weekCircle = weekCard.querySelector('.week-circle');
    if (weekCircle) {
      const text = weekCircle.textContent.trim();
      const match = text.match(/W(\d+)/);
      return match ? parseInt(match[1]) : null;
    }
    return null;
  }

  function getWeekCardElement(weekNumber) {
    return Array.from(document.querySelectorAll('.week-card')).find(card => extractWeekNumber(card) === weekNumber);
  }

  function collectSkillsFromWeekCard(weekCard) {
    const titles = Array.from(weekCard.querySelectorAll('.item-title')).map(el => el.textContent.trim()).filter(Boolean);
    const uniqueTitles = [...new Set(titles)];
    if (uniqueTitles.length > 0) {
      return uniqueTitles;
    }
    const header = weekCard.querySelector('.week-title-group h3')?.textContent.trim();
    return header ? [header] : [];
  }

  function buildCertificateProfile(weekCard, weekNumber) {
    const overrides = COURSE_SKILL_LIBRARY?.[CURRENT_COURSE]?.[weekNumber] || null;
    let theme = overrides?.theme || overrides?.title || overrides?.certificate || '';
    const weekHeader = weekCard.querySelector('.week-title-group h3')?.textContent.trim() || `Week ${weekNumber}`;
    if (!theme) {
      const headerParts = weekHeader.split(':');
      theme = headerParts.length > 1 ? headerParts[1].trim() : weekHeader;
    }
    const skills = (overrides?.skills && overrides.skills.length > 0) ? overrides.skills : collectSkillsFromWeekCard(weekCard);
    if (skills.length === 0) {
      skills.push(theme);
    }
    return {
      weekNumber,
      theme,
      displayName: overrides?.certificate || `Week ${weekNumber}: ${theme}`,
      courseName: COURSE_LABELS[CURRENT_COURSE] || CURRENT_COURSE,
      skills
    };
  }

  function renderWeekSkillPreviews() {
    document.querySelectorAll('.week-card').forEach(card => {
      const preview = card.querySelector('[data-week-skills]');
      if (!preview) return;
      const weekNumber = extractWeekNumber(card);
      const profile = buildCertificateProfile(card, weekNumber);
      if (!profile) return;
      preview.innerHTML = '';
      profile.skills.slice(0, 6).forEach(skill => {
        const chip = document.createElement('span');
        chip.className = 'skill-chip';
        chip.textContent = skill;
        preview.appendChild(chip);
      });
      const weekTitle = card.querySelector('[data-week-title]');
      if (weekTitle) {
        weekTitle.textContent = `Week ${weekNumber}: ${profile.theme}`;
      }

    });
  }

  // Get available certificates for a week
  function getAvailableCertificates(weekNumber) {
    console.log('Getting certificates for week:', weekNumber);
    const weekCard = getWeekCardElement(weekNumber);

    if (!weekCard) {
      console.log('Week card not found for week:', weekNumber);
      return [];
    }

    const itemCards = weekCard.querySelectorAll('.item-card');
    console.log('Found', itemCards.length, 'item cards');
    if (itemCards.length === 0) {
      return [];
    }

    const allCompleted = Array.from(itemCards).every(card => card.classList.contains('completed'));
    if (!allCompleted) {
      console.log('Week not fully completed, certificates locked.');
      return [];
    }

    const profile = buildCertificateProfile(weekCard, weekNumber);
    if (!profile) {
      return [];
    }

    const certificates = (profile.skills || []).map(skillName => {
      return {
        weekNumber: profile.weekNumber,
        theme: profile.theme,
        courseName: profile.courseName,
        skill: skillName,
        displayName: `${profile.theme} â€“ ${skillName}`,
        slug: `${CURRENT_COURSE}-${profile.weekNumber}-${skillName}`.toLowerCase().replace(/[^a-z0-9]+/g, '-')
      };
    });

    return certificates;
  }

  // Open progression modal
  function openProgressionModal(weekCard) {
    const weekNumber = extractWeekNumber(weekCard);
    console.log('Opening progression modal for week:', weekNumber);
    if (!weekNumber) {
      console.log('No week number found, returning');
      return;
    }

    currentModalWeekNumber = weekNumber;
    console.log('Set currentModalWeekNumber to:', currentModalWeekNumber);

    // Set week number and theme
    document.getElementById('modal-week-number').textContent = weekNumber;
    const weekTitle = weekCard.querySelector('h3').textContent.split(':')[1]?.trim() || '';
    document.getElementById('modal-week-theme').textContent = weekTitle;

    // Populate task list
    const taskList = document.getElementById('task-list');
    taskList.innerHTML = '';

    const itemCards = weekCard.querySelectorAll('.item-card');
    itemCards.forEach((card, index) => {
      const title = card.querySelector('.item-title').textContent;
      const isCompleted = card.classList.contains('completed');
      const taskDiv = document.createElement('div');
      taskDiv.className = 'progression-task';
      taskDiv.innerHTML = `
        <input type="checkbox" id="task-${index}" ${isCompleted ? 'checked' : ''}>
        <label for="task-${index}">${title}</label>
        <span class="task-number">#${index + 1}</span>
      `;

      // Add change listener
      const checkbox = taskDiv.querySelector('input[type="checkbox"]');
      checkbox.addEventListener('change', function() {
        const toggleBtn = card.querySelector('.completion-toggle');
        if (toggleBtn) {
          toggleCompletion(toggleBtn);
          updateModalProgress();
          updateCertificateStatus();
        }
      });

      taskList.appendChild(taskDiv);
    });

    updateModalProgress();
    updateCertificateStatus();

    // Show modal
    document.getElementById('progression-modal').style.display = 'block';
  }

  // Close progression modal
  function closeProgressionModal() {
    document.getElementById('progression-modal').style.display = 'none';
  }

  // Update modal progress
  function updateModalProgress() {
    const checkboxes = document.querySelectorAll('#task-list input[type="checkbox"]');
    const checked = document.querySelectorAll('#task-list input[type="checkbox"]:checked');
    const progress = checkboxes.length > 0 ? (checked.length / checkboxes.length) * 100 : 0;
    document.getElementById('modal-progress-fill').style.width = `${progress}%`;
  }

  // Update certificate status
  function updateCertificateStatus() {
    const availableCertificates = getAvailableCertificates(currentModalWeekNumber);
    const certificateStatus = document.getElementById('certificate-status');

    if (availableCertificates.length > 0) {
      certificateStatus.innerHTML = `
        <button id="view-certificate-btn">ðŸŽ“ View Your Certificate</button>
      `;
    } else {
      certificateStatus.innerHTML = `
        <p style="color: #666; text-align: center;">Complete all tasks to unlock certificates</p>
      `;
    }
  }

  // Open certificate list modal
  function openCertificateListModal(weekNumber) {
    document.getElementById('list-modal-week-number').textContent = weekNumber;
    const certificateList = document.getElementById('certificate-list');
    certificateList.innerHTML = '';

    const availableCertificates = getAvailableCertificates(weekNumber);

    if (availableCertificates.length === 0) {
      certificateList.innerHTML = '<p style="color: #666; text-align: center;">No certificates available yet</p>';
    } else {
      availableCertificates.forEach(profile => {
        const button = document.createElement('button');
        button.textContent = `${profile.displayName}`;
        button.addEventListener('click', () => {
          openCertificateModal(profile);
        });
        certificateList.appendChild(button);
      });
    }

    document.getElementById('certificate-list-modal').style.display = 'block';
  }

  // Open certificate modal
  function openCertificateModal(profile) {
    activeCertificateProfile = profile;
    document.getElementById('certificate-week-theme').textContent = profile.theme;
    document.getElementById('certificate-course-name').textContent = profile.courseName;

    // Set date
    const now = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('certificate-date').textContent = now.toLocaleDateString('en-US', options);

    // Set skills
    const skillFocus = profile.skill || profile.theme;
    document.getElementById('certificate-skill-focus').textContent = skillFocus;

    const skillsContainer = document.getElementById('skills-container');
    skillsContainer.innerHTML = '';
    const skillTag = document.createElement('span');
    skillTag.className = 'skill-tag';
    skillTag.textContent = skillFocus;
    skillsContainer.appendChild(skillTag);

    // Track earned certificate
    trackEarnedCertificate(profile);

    // Close list modal and open certificate modal
    document.getElementById('certificate-list-modal').style.display = 'none';
    document.getElementById('certificate-modal').style.display = 'block';
  }

  // Track earned certificates for leaderboard
  function trackEarnedCertificate(profile) {
    const CERTIFICATES_KEY = `${CURRENT_COURSE}-earned-certificates`;
    let earnedCerts = [];
    
    try {
      earnedCerts = JSON.parse(localStorage.getItem(CERTIFICATES_KEY) || '[]');
    } catch(e) {
      earnedCerts = [];
    }

    // Create certificate record
    const certRecord = {
      id: profile.slug || `week-${profile.weekNumber}-${profile.skill}`,
      weekNumber: profile.weekNumber,
      theme: profile.theme,
      skill: profile.skill,
      earnedDate: new Date().toISOString()
    };

    // Check if already earned
    const exists = earnedCerts.some(c => c.id === certRecord.id);
    if (!exists) {
      earnedCerts.push(certRecord);
      localStorage.setItem(CERTIFICATES_KEY, JSON.stringify(earnedCerts));

      // Update user stats with certificate count
      const stats = initializeUserStats();
      if (!stats.earnedCertificates) stats.earnedCertificates = [];
      if (!stats.earnedCertificates.includes(certRecord.id)) {
        stats.earnedCertificates.push(certRecord.id);
        // Bonus XP for earning certificate
        stats.xp += 100;
        saveUserStats(stats);
      }
    }
  }

  // Close certificate modal
  function closeCertificateModal() {
    document.getElementById('certificate-modal').style.display = 'none';
  }

  // Close certificate list modal
  function closeCertificateListModal() {
    document.getElementById('certificate-list-modal').style.display = 'none';
  }

  // Download certificate
  function downloadCertificate() {
    const certificateContent = document.getElementById('certificate-content');
    html2canvas(certificateContent, {
      scale: 3,
      backgroundColor: '#ffffff',
      logging: false,
      useCORS: true
    }).then(canvas => {
      const link = document.createElement('a');
      link.download = 'certificate.png';
      link.href = canvas.toDataURL();
      link.click();
    });
  }

  // Print certificate
  function printCertificate() {
    window.print();
  }

  // Share on LinkedIn by opening the certification form with prefilled data
  function shareOnLinkedIn() {
    const profile = activeCertificateProfile;
    const certificateName = profile?.displayName || profile?.theme || document.getElementById('certificate-week-theme')?.textContent.trim() || 'Course Module Completion';
    const courseName = profile?.courseName || document.getElementById('certificate-course-name')?.textContent.trim() || 'Open Coding Society';
    const studentName = document.getElementById('certificate-student-name')?.textContent.trim() || 'Learner';
    const issueDateText = document.getElementById('certificate-date')?.textContent.trim() || '';  
    const skillFocus = profile?.skill || document.getElementById('certificate-skill-focus')?.textContent.trim() || certificateName;

    let issueMonth = '';
    let issueYear = '';

    if (issueDateText) {
      const parsedDate = new Date(issueDateText);
      if (!isNaN(parsedDate.getTime())) {
        issueMonth = (parsedDate.getMonth() + 1).toString();
        issueYear = parsedDate.getFullYear().toString();
      }
    }

    const params = new URLSearchParams({
      startTask: 'CERTIFICATION_NAME',
      name: `${certificateName}`,
      organizationName: 'Open Coding Society',
      issueYear,
      issueMonth,
      description: `Awarded to ${studentName} for demonstrating ${skillFocus} during ${courseName}.`,
      credentialUrl: window.location.href
    });

    const linkedInUrl = `https://www.linkedin.com/profile/add?${params.toString()}`;
    window.open(linkedInUrl, '_blank', 'noopener');
  }

  function updateLeaderboard(userStats) {
   let leaderboard = [];
  
   try {
     const stored = localStorage.getItem(LEADERBOARD_KEY);
     leaderboard = stored ? JSON.parse(stored) : [];
   } catch (e) {
     leaderboard = [];
   }
  
   // Update or add user
   const existingIndex = leaderboard.findIndex(u => u.username === userStats.username);
  
   if (existingIndex >= 0) {
     leaderboard[existingIndex] = userStats;
   } else {
     leaderboard.push(userStats);
   }
  
   // Sort by XP
   leaderboard.sort((a, b) => b.xp - a.xp);
  
   localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(leaderboard));
 }


 function refreshLeaderboardDisplay() {
   const leaderboard = JSON.parse(localStorage.getItem(LEADERBOARD_KEY) || '[]');
   const currentUser = initializeUserStats();
   const tbody = document.getElementById('leaderboard-body');
  
   if (!tbody) return;
  
   tbody.innerHTML = '';
  
   leaderboard.forEach((user, index) => {
     const rank = index + 1;
     const isCurrentUser = user.username === currentUser.username;
     const completionRate = user.totalItems > 0
       ? ((user.totalCompleted / user.totalItems) * 100).toFixed(1)
       : 0;
    
     const row = document.createElement('tr');
     if (isCurrentUser) row.classList.add('current-user');
    
     row.innerHTML = `
       <td class="rank-cell ${rank <= 3 ? 'top-3' : ''}">
         #${rank}
       </td>
       <td>
         <div class="student-cell">
           <div class="student-avatar">${user.username[0].toUpperCase()}</div>
           <span>${user.username}${isCurrentUser ? ' (You)' : ''}</span>
         </div>
       </td>
       <td>${completionRate}%</td>
       <td>${user.currentStreak} days</td>
       <td>${user.xp}</td>
       <td class="badges-cell">
         ${generateBadges(user)}
       </td>
     `;
    
     tbody.appendChild(row);
   });
  
   // Update user stats display
   updateUserStatsDisplay(currentUser, leaderboard);
 }


 function generateBadges(user) {
   const badges = [];
  
   if (user.currentStreak >= 7) badges.push('Streak 7+');
   if (user.currentStreak >= 30) badges.push('Streak 30+');
   if (user.xp >= 1000) badges.push('XP 1000+');
   if (user.longestStreak >= 14) badges.push('Longest Streak 14+');
  
   const weeklyCompleteCount = Object.values(user.weeklyProgress || {})
     .filter(w => w.completed === w.total).length;
   if (weeklyCompleteCount >= 5) badges.push('Weekly Master');
  
   return badges.map(b => `<span class="badge-icon" title="Achievement">${b}</span>`).join('');
 }


 function updateUserStatsDisplay(user, leaderboard) {
   const rank = leaderboard.findIndex(u => u.username === user.username) + 1;
   const completionRate = user.totalItems > 0
     ? ((user.totalCompleted / user.totalItems) * 100).toFixed(1)
     : 0;
  
   document.getElementById('user-rank').textContent = rank > 0 ? `#${rank}` : '--';
   document.getElementById('user-streak').textContent = `${user.currentStreak} days`;
   document.getElementById('user-xp').textContent = user.xp;
   document.getElementById('user-completion').textContent = `${completionRate}%`;
 }


 // Data Visualization
 function initializeCharts() {
   createWeeklyProgressChart();
   createQuestTimeline();
 }


 function createWeeklyProgressChart() {
   const canvas = document.getElementById('weekly-progress-chart');
   if (!canvas) return;
  
   const stats = initializeUserStats();
   const weeklyData = stats.weeklyProgress || {};
  
   const weeks = Object.keys(weeklyData).sort((a, b) => parseInt(a) - parseInt(b));
   const completionRates = weeks.map(week => {
     const data = weeklyData[week];
     return data.total > 0 ? (data.completed / data.total) * 100 : 0;
   });
  
   new Chart(canvas, {
     type: 'line',
     data: {
       labels: weeks.map(w => `Week ${w}`),
       datasets: [{
         label: 'Completion %',
         data: completionRates,
         borderColor: '#60a5fa',
         backgroundColor: 'rgba(96, 165, 250, 0.1)',
         tension: 0.4,
         fill: true
       }]
     },
     options: {
       responsive: true,
       maintainAspectRatio: true,
       plugins: {
         legend: { display: false },
         tooltip: {
           backgroundColor: '#1f1f1f',
           titleColor: '#ffffff',
           bodyColor: '#e0e0e0'
         }
       },
       scales: {
         y: {
           beginAtZero: true,
           max: 100,
           ticks: { color: '#999999' },
           grid: { color: '#2a2a2a' }
         },
         x: {
           ticks: { color: '#999999' },
           grid: { color: '#2a2a2a' }
         }
       }
     }
   });
 }


 function createQuestTimeline() {
   const container = document.getElementById('quest-timeline');
   if (!container) return;
  
   const completionData = loadCompletionData();
   const timeline = [];
  
   // Build timeline from completion data
   document.querySelectorAll('.item-card').forEach(card => {
     const itemId = card.dataset.itemId;
     if (completionData[itemId]) {
       const title = card.querySelector('.item-title').textContent;
       const weekCard = card.closest('.week-card');
       const weekNum = extractWeekNumber(weekCard);
      
       timeline.push({
         title,
         week: weekNum,
         date: new Date() // In real implementation, track actual completion date
       });
     }
   });
  
   // Sort by date (most recent first)
   timeline.sort((a, b) => b.date - a.date);
  
   container.innerHTML = timeline.slice(0, 10).map(item => `
     <div class="timeline-item">
       <div class="timeline-marker"></div>
       <div class="timeline-content">
         <div class="timeline-title">${item.title}</div>
         <div class="timeline-date">Week ${item.week} â€¢ ${item.date.toLocaleDateString()}</div>
       </div>
     </div>
   `).join('');
 }


 // Activity heatmap and challenge performance charts removed


 function sortLeaderboard(criteria) {
   const leaderboard = JSON.parse(localStorage.getItem(LEADERBOARD_KEY) || '[]');
  
   leaderboard.sort((a, b) => {
     switch(criteria) {
       case 'completion':
         const aRate = a.totalItems > 0 ? a.totalCompleted / a.totalItems : 0;
         const bRate = b.totalItems > 0 ? b.totalCompleted / b.totalItems : 0;
         return bRate - aRate;
       case 'streak':
         return b.currentStreak - a.currentStreak;
       case 'xp':
       default:
         return b.xp - a.xp;
     }
   });
  
   localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(leaderboard));
   refreshLeaderboardDisplay();
 }

  // Initialize certificate system
  function initializeCertificateSystem() {
    console.log('Initializing certificate system');

    const weekCards = document.querySelectorAll('.week-card');
    console.log('Found', weekCards.length, 'week cards');

    const progressButtons = document.querySelectorAll('.week-card .progression-btn');
    progressButtons.forEach(button => {
      button.addEventListener('click', (event) => {
        event.preventDefault();
        event.stopPropagation();
        const weekCard = button.closest('.week-card');
        if (weekCard) {
          openProgressionModal(weekCard);
        }
      });
    });

    weekCards.forEach(card => {
      card.classList.add('clickable');
      card.addEventListener('click', (event) => {
        if (event.target.closest('a') || event.target.closest('.completion-toggle') || event.target.closest('.progression-btn')) {
          return;
        }
        event.preventDefault();
        openProgressionModal(card);
      });
    });

    function toggleSprint(card, control) {
      const isCollapsed = card.classList.toggle('collapsed');
      if (control) {
        control.setAttribute('aria-expanded', (!isCollapsed).toString());
        control.querySelector('.sprint-toggle-icon').textContent = isCollapsed ? 'â–¸' : 'â–¾';
      }
    }

    document.querySelectorAll('.sprint-card').forEach(card => {
      const toggleBtn = card.querySelector('.sprint-toggle-btn');
      if (toggleBtn) {
        toggleBtn.querySelector('.sprint-toggle-icon').textContent = 'â–¸';
        toggleBtn.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          toggleSprint(card, toggleBtn);
        });
      }
      card.querySelector('.sprint-header').addEventListener('click', (event) => {
        if (event.target.closest('.sprint-controls')) {
          return;
        }
        toggleSprint(card, toggleBtn);
      });
    });

    // Close buttons
    document.getElementById('close-progression-modal').addEventListener('click', closeProgressionModal);
    document.getElementById('close-certificate-list-modal').addEventListener('click', closeCertificateListModal);
    document.getElementById('close-certificate-modal').addEventListener('click', closeCertificateModal);
    // Defensive binding for the newly added top-right X on the certificate modal
    if (document.getElementById('close-certificate-modal-x')) {
      document.getElementById('close-certificate-modal-x').addEventListener('click', closeCertificateModal);
    }

    // Allow closing modals with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' || e.key === 'Esc') {
        // Only attempt to close if modals are currently open
        try { if (document.getElementById('progression-modal').style.display === 'block') closeProgressionModal(); } catch (err) {}
        try { if (document.getElementById('certificate-list-modal').style.display === 'block') closeCertificateListModal(); } catch (err) {}
        try { if (document.getElementById('certificate-modal').style.display === 'block') closeCertificateModal(); } catch (err) {}
      }
    });

    // Certificate actions
    document.getElementById('download-certificate-btn').addEventListener('click', downloadCertificate);
    document.getElementById('print-certificate-btn').addEventListener('click', printCertificate);
    document.getElementById('linkedin-share-btn').addEventListener('click', shareOnLinkedIn);

    // View certificate button
    document.addEventListener('click', function(e) {
      if (e.target.id === 'view-certificate-btn') {
        closeProgressionModal();
        openCertificateListModal(currentModalWeekNumber);
      }
    });
  }

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', function() {
    initializeProgressBars();
    initializeCompletion();
    applyFilters();
    initializeCertificateSystem();
    renderWeekSkillPreviews();
    
    // Prompt for username if not set (still needed for tracking)
    if (!localStorage.getItem('student-username')) {
      const username = prompt('Enter your name for the leaderboard:');
      if (username) {
        localStorage.setItem('student-username', username);
        const stats = initializeUserStats();
        stats.username = username;
        saveUserStats(stats);
      }
    }
  });

  // Lightweight mobile detection redirect to /mobile/ (only for small screens)
  (function(){
    try {
      if (window.matchMedia('(max-width: 640px)').matches && !window.location.pathname.startsWith('/mobile')) {
        // Avoid interfering with user-agent previews and bots
        if (!navigator.userAgent.includes('Slackbot') && !navigator.userAgent.includes('Twitterbot')) {
          window.location.replace('/mobile/');
        }
      }
    } catch(e){}
  })();
</script>
